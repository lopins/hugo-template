<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="Huabing Blog"><meta property="og:type" content="article"><meta property="og:image" content="https://www.zhaohuabing.com/img/travel/PXL_20240525_032754131.jpeg"><meta property="twitter:image" content="https://www.zhaohuabing.com/img/travel/PXL_20240525_032754131.jpeg"><meta name=title content="Envoy Gateway v 1.1.0 版本发布：新功能与改进介绍"><meta property="og:title" content="Envoy Gateway v 1.1.0 版本发布：新功能与改进介绍"><meta property="twitter:title" content="Envoy Gateway v 1.1.0 版本发布：新功能与改进介绍"><meta name=description content="Envoy Gateway（本文中简称 EG）在 7 月 23 日发布了最新的 1.1 版本。1.1 版本 EG 在 1.0 GA （General Availability）版本后的第一个功能更新版本，那么该版本中有哪些重要的新特性和改进呢？本文将为您一一介绍。"><meta property="og:description" content="Envoy Gateway（本文中简称 EG）在 7 月 23 日发布了最新的 1.1 版本。1.1 版本 EG 在 1.0 GA （General Availability）版本后的第一个功能更新版本，那么该版本中有哪些重要的新特性和改进呢？本文将为您一一介绍。"><meta property="twitter:description" content="Envoy Gateway（本文中简称 EG）在 7 月 23 日发布了最新的 1.1 版本。1.1 版本 EG 在 1.0 GA （General Availability）版本后的第一个功能更新版本，那么该版本中有哪些重要的新特性和改进呢？本文将为您一一介绍。"><meta property="twitter:card" content="summary"><meta name=keyword content="赵化冰, zhaohuabing, Zhaohuabing, , 赵化冰的网络日志, 赵化冰的博客, Zhaohuabing Blog, 博客, 个人网站, 互联网, Web, 云原生, PaaS, Istio, Kubernetes, 微服务, Microservice"><link rel="shortcut icon" href=/hugo-template/img/favicon.ico><title>Envoy Gateway v 1.1.0 版本发布：新功能与改进介绍 | 赵化冰的博客 | Zhaohuabing Blog</title>
<link rel=canonical href=/hugo-template/post/2024-06-16-eg-1.1.0/><link rel=stylesheet href=/hugo-template/css/bootstrap.min.css><link rel=stylesheet href=/hugo-template/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/hugo-template/css/zanshang.css><link rel=stylesheet href=/hugo-template/css/font-awesome.all.min.css><script src=/hugo-template/js/jquery.min.js></script><script src=/hugo-template/js/bootstrap.min.js></script><script src=/hugo-template/js/hux-blog.min.js></script><script src=/hugo-template/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=/>Huabing Blog</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/hugo-template/categories/books/>books</a></li><li><a href=/hugo-template/categories/open-source/>open source</a></li><li><a href=/hugo-template/categories/presentations/>presentations</a></li><li><a href=/hugo-template/categories/tech/>tech</a></li><li><a href=/archive//>ARCHIVE</a></li><li><a href=/notes//>NOTES</a></li><li><a href=/about//>ABOUT</a></li><li><a href=/hugo-template/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(https://www.zhaohuabing.com/img/travel/PXL_20240525_032754131.jpeg)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/envoy title=Envoy>Envoy
</a><a class=tag href=/tags/envoy-gateway title="Envoy Gateway">Envoy Gateway</a></div><h1>Envoy Gateway v 1.1.0 版本发布：新功能与改进介绍</h1><h2 class=subheading></h2><span class=meta>Posted by
Huabing Blog
on
Wednesday, July 10, 2024</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p>Envoy Gateway（本文中简称 EG）在 7 月 23 日发布了最新的 1.1.0 版本。1.1.0 版本 EG 在 1.0 GA （General Availability）版本后的第一个功能更新版本，包含了多个新特性和改进。本文将为大家介绍我认为其中最重要的几个新特性。</p><h2 id=wasm-扩展>Wasm 扩展</h2><p>Wasm 是 Envoy 的一个重要扩展机制，通过为 Envoy 配置 Wasm 扩展，可以在 Envoy 的 HTTP 请求和响应流程中插入自定义的处理逻辑。采用 Wasm 扩展有多个优势：首先，Wasm 扩展可以用多种语言编写，比如 C++，Rust，Go 等。这使得用户在编写扩展时可以选择自己熟悉的语言，降低了学习成本。其次，Wasm 插件是独立的二进制文件，不需要编译在 Envoy 的二进制中，这解藕了 Envoy 和扩展组件的生命周期，让用户可以在运行期对 Envoy 进行灵活扩展。除此之外，由于 Wasm 运行在一个沙箱环境中，该沙箱环境对应用代码的操作权限进行了严格的控制，只能访问 Envoy 提供的指定 API，因此 Wasm 扩展也提供了很好的安全性。</p><p>Envoy 原生只支持从本地文件或者 HTTP 下载 Wasm 扩展，这两种方式具有一定的局限性，特别是缺少对 Wasm 扩展的版本管理和权限控制。在 1.1.0 版本中，EG 通过 EnvoyExtensionPolicy CRD 提供了对 OCI 镜像格式的 Wasm 扩展支持。OCI 镜像使得用户可以更加方便地管理 Wasm 扩展插件的不同版本，同时也支持采用私用镜像对用户进行权限控制，增强了扩展插件的安全性。</p><p>下面是一个采用 EnvoyExtensionPolicy CRD 配置 OCI 镜像格式的 Wasm 扩展的例子：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: gateway.envoyproxy.io/v1alpha1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: EnvoyExtensionPolicy
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: oci-wasm-source-test
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>targetRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>group</span>: gateway.networking.k8s.io
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>kind</span>: HTTPRoute
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: http-with-oci-wasm-source
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>wasm</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>name</span>: wasm-filter
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>code</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>type</span>: Image
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>image</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>url</span>: <span style=color:#f1fa8c>&#34;zhaohuabing/testwasm:v0.0.1&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>sha256</span>: cdb37a856ae7dae208cdcb19378022cc81dbcae30859f58b89ae259a9575a49d
</span></span></code></pre></div><p>如果 Wasm 扩展插件的镜像是私有的，可以通过配置 imagePullSecrets 来指定镜像拉取的凭证，也支持
配置 pullPolicy 来指定镜像拉取的策略。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: gateway.envoyproxy.io/v1alpha1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: EnvoyExtensionPolicy
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: oci-wasm-source-test
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>targetRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>group</span>: gateway.networking.k8s.io
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>kind</span>: HTTPRoute
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: http-with-oci-wasm-source
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>wasm</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>name</span>: wasm-filter
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>rootID</span>: my_root_id
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>code</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>type</span>: Image
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>image</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>url</span>: oci://my-private-registry/wasm-filter-2:v1.0.0
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>pullSecretRef</span>:
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>name</span>: my-pull-secret
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>pullPolicy</span>: Always
</span></span></code></pre></div><p>EnvoyExtensionPolicy 也支持通过 HTTP 下载 Wasm 扩展：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: gateway.envoyproxy.io/v1alpha1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: EnvoyExtensionPolicy
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: http-wasm-source-test
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>targetRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>group</span>: gateway.networking.k8s.io
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>kind</span>: HTTPRoute
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: http-with-http-wasm-source
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>wasm</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>name</span>: wasm-filter
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>rootID</span>: my_root_id
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>code</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>type</span>: HTTP
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>http</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>url</span>: https://raw.githubusercontent.com/envoyproxy/envoy/main/examples/wasm-cc/lib/envoy_filter_http_wasm_example.wasm
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>sha256</span>: 79c9f85128bb0177b6511afa85d587224efded376ac0ef76df56595f1e6315c0
</span></span></code></pre></div><h2 id=external-process-扩展>External Process 扩展</h2><p>除了 Wasm 扩展，EG 1.1.0 版本还引入了 External Process（外部进程）扩展。通过 External Process 扩展，用户可以采用一个独立的进程来实现对 Envoy 的自定义处理逻辑。Envoy 和 External Process 进程之间通过 gRPC 进行通信，Envoy 将收到的 HTTP 请求/响应消息通过 gRPC 调用发送给 External Process 进程，External Process 处理后在通过 gRPC 将结果返回给 Envoy。</p><p>External Process 扩展的主要优势在于其实现的灵活性：除了一个 gPRC 的调用接口之外，Envoy 对扩展的实现没有任何限制。用户可以完全控制扩展进行的内部实现，包括其使用的语言，调用哪些外部服务等等。此外，由于 External Process 扩展是独立的进程，其内部的状态和资源不会影响到 Envoy 的运行，Envoy 的安全性也得到了更好的保障。</p><p>下面是一个 External Process 扩展的例子：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: gateway.envoyproxy.io/v1alpha1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: EnvoyExtensionPolicy
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: ext-proc-example
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>targetRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>group</span>: gateway.networking.k8s.io
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>kind</span>: HTTPRoute
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: myapp
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>extProc</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ff79c6>backendRefs</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>name</span>: grpc-ext-proc
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>port</span>: <span style=color:#bd93f9>9002</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>processingMode</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>request</span>: {}
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>response</span>: 
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>body</span>: Streamed 
</span></span></code></pre></div><h2 id=为非-k8s-服务提供直接支持>为非 K8s 服务提供直接支持</h2><p>1.0.0 中 EG 支持了 Service 和 ServiceImport 两种 K8s 原生的后端服务的定义方式。对于 K8s 集群外部的服务，EG 建议通过创建 EndpointSlice 的方式来间接支持。</p><p>在 1.1.0 中，EG 引入了一个新的 API Backend，直接支持了非 K8s 服务的定义。除了覆盖了已通过 EndpointSlice 方式支持的 IP 地址 和 FQDN 域名两种地址类型之外，Backend 还支持了 Unix Domain Socket 地址类型。IP 地址和 FQDN 域名用于访问集群外部的服务，而 Unix Domain Socket 则可以用于访问和 Envoy 部署在同一个 Pod 中的服务。例如，External Process 扩展进程就可以作为一个 Sidecar 部署在 Envoy Pod 中，通过 Unix Domain Socket 和 Envoy 进行通信，以避免网络通信的开销。</p><p>1.1.0 版本中，Backend 已经支持作为 HTTPRoute 和 ExtensionPolicy 的 BackendReference，后续版本会根据用户需求逐步扩展到其他资源中。除此之外，BackendTLSPolicy 也可以被关联到 Backend 上，以支持对非 K8s 服务的 TLS 配置。</p><p>下面的例子中，我们定义了一个 Backend 对象，并将其作为 HTTPRoute 的后端服务，用于访问 httpbin.org 这个外部服务：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: gateway.networking.k8s.io/v1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: HTTPRoute
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: backend
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>parentRefs</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>name</span>: eg
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>hostnames</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f1fa8c>&#34;www.example.com&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>rules</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>backendRefs</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>group</span>: gateway.envoyproxy.io
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>kind</span>: Backend
</span></span><span style=display:flex><span>          <span style=color:#ff79c6>name</span>: httpbin
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>matches</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>path</span>:
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>type</span>: PathPrefix
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>value</span>: /
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: gateway.envoyproxy.io/v1alpha1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Backend
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: httpbin
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>endpoints</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>fqdn</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>hostname</span>: httpbin.org
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>port</span>: <span style=color:#bd93f9>80</span>
</span></span></code></pre></div><h2 id=支持-ip-黑白名单>支持 IP 黑白名单</h2><p>IP 黑白名单是一个常见的安全控制手段，通过配置 IP 黑白名单，可以限制允许访问服务的客户端 IP 地址范围。在 1.1.0 版本中，EG 通过 SecurityPolicy CRD 支持了 IP 黑白名单的配置。</p><p>例如下面的 SecurityPolicy 对访问 http-with-authorization-client-ip 这个 HTTPRoute 的请求进行了访问控制。缺省的访问策略设置为 Deny，只有在策略中明确指定的 IP 段 10.0.1.0/24 和 10.0.2.0/24 这两个 IP 段才能访问该 HTTPRoute。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: gateway.envoyproxy.io/v1alpha1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: SecurityPolicy
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: authorization-client-ip
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>targetRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>group</span>: gateway.networking.k8s.io
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>kind</span>: HTTPRoute
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: http-with-authorization-client-ip
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>authorization</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>defaultAction</span>: Deny
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>rules</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>action</span>: Allow
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>principal</span>:
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>clientCIDRs</span>:
</span></span><span style=display:flex><span>        - <span style=color:#bd93f9>10.0.1.0</span>/24
</span></span><span style=display:flex><span>        - <span style=color:#bd93f9>10.0.2.0</span>/24
</span></span></code></pre></div><p>需要注意的是，如果客户端请求在到达 EG 之前还经过了会改变源 IP 地址的中间节点，则需要通过配置 ClientTrafficPolicy 来获取客户端的真实 IP 地址（如希望进一步了解获取客户端真实 IP 地址的原理，可以参考<a href=https://www.zhaohuabing.com/post/2024-05-17-client-ip/>《如何通过 Envoy Gateway 得到客户端的真实 IP 地址？》</a>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: gateway.envoyproxy.io/v1alpha1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: ClientTrafficPolicy
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: enable-client-ip-detection
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>clientIPDetection</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>xForwardedFor</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>numTrustedHops</span>: <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>targetRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>group</span>: gateway.networking.k8s.io
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>kind</span>: HTTPRoute
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: http-with-authorization-client-ip
</span></span></code></pre></div><h2 id=支持会话保持>支持会话保持</h2><p>对于有状态的服务，来自同一个客户端的多个 HTTP 请求需要被路由到同一个后端到服务实例上进行处理，以保证客户端的请求能够被正确处理。EG 1.1.0 中支持了一致性哈希负载均衡算法，以支持会话保持（Session Persistence）。目前版本支持按照客户端 IP 地址, Cookie, 或者 HTTP header 三种方式来保持会话。</p><p>备注： 1.1.0 通过一致性哈希负载均衡算法实现的是弱会话保持，即同一个客户端的请求在一定时间内会被路由到同一个后端服务实例上，但是如果后端服务实例发生了变化，比如扩容或者缩容，那么会话保持的效果会失效。EG 在后续版本中会支持强会话保持，即无论后端服务实例的变化，同一个客户端的请求都会被路由到同一个后端服务实例上。</p><p>下面是一个采用客户端 IP 地址来进行会话保持的例子。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: gateway.envoyproxy.io/v1alpha1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: BackendTrafficPolicy
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: policy-for-route-1
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>targetRef</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>group</span>: gateway.networking.k8s.io
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>kind</span>: HTTPRoute
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: httproute-1
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>loadBalancer</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>type</span>: ConsistentHash
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>consistentHash</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>type</span>: SourceIP
</span></span></code></pre></div><h2 id=支持自定义-filter-顺序>支持自定义 Filter 顺序</h2><p>EG 中提供了 <code>BacendTrafficPolicy</code>, <code>SecurityPolicy</code>等灵活的策略来对请求进行处理，这些策略是通过 Envoy 的 HTTP Filter 来实现的。EG 向 Envoy 下发的 Filter 执行顺序是固定的，该顺序在大部分情况下是合理的，但是在某些情况下，用户可能希望调整缺省的 Filter 执行顺序。例如，用户可能希望把 Rate Limit Filter 放在最前面，以便在请求到达后立即对请求进行限流，减少后续 Filter 的处理压力。</p><p>在 1.1.0 版本中，EG 在 EnvoyProxy CRD 中增加了一个新的字段 filterOrder，用户可以通过该字段来指定 Filter 的执行顺序。</p><p>下面是一个自定义 Filter 顺序的例子，其中指定了 Wasm Filter 在 JWT Filter 之前执行，CORS Filter 在 Basic Auth Filter 之后执行。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: gateway.envoyproxy.io/v1alpha1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: EnvoyProxy
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: custom-proxy-config
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>namespace</span>: envoy-gateway-system
</span></span><span style=display:flex><span><span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>filterOrder</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>name</span>: envoy.filters.http.wasm
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>before</span>: envoy.filters.http.jwt_authn
</span></span><span style=display:flex><span>    - <span style=color:#ff79c6>name</span>: envoy.filters.http.cors
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>after</span>: envoy.filters.http.basic_authn
</span></span></code></pre></div><h2 id=总结>总结</h2><p>Envoy Gateway 1.1.0 版本引入了多个新特性和改进，包括 Wasm 扩展的 OCI 镜像支持，External Process 扩展，非 K8s 服务的直接支持，IP 黑白名单，会话保持，自定义 Filter 顺序等。这些新特性和改进使得 EG 在更多的场景下可以发挥作用，为用户提供了更多的灵活性和可定制性。同时，EG 1.1.0 版本也修复了之前版本中的一些 bug，提升了稳定性和性能。</p><p>根据我从社区中接到的反馈得知，一些大型的企业用户已经开始在其产品或者服务中采用 Envoy Gateway，包括 SAP，Docker，Siemens 等。欢迎大家下载试用 EG 1.1.0 版本，并向社区反馈您的使用体验和建议。</p><p>EG 1.1.0 版本的详细更新内容可以参考<a href=https://github.com/envoyproxy/gateway/releases/tag/v1.1.0>Relase 变更清单</a>。</p><h2 id=参考>参考</h2><p>EG 1.1.0 版本下载：https://github.com/envoyproxy/gateway/releases/tag/v1.1.0
Release 变更清单：https://gateway.envoyproxy.io/news/releases/v1.1/</p><div class="entry-shang text-center"><p>「真诚赞赏，手留余香」</p><button class="zs show-zs btn btn-bred">赞赏支持</button></div><div class=zs-modal-bg></div><div class=zs-modal-box><div class=zs-modal-head><button type=button class=close>×</button>
<span class=author><a href=https://lopins.github.io/hugo-template/><img src=/hugo-template/img/favicon.png>Huabing Blog</a></span><p class=tip><i></i><span>真诚赞赏，手留余香</span></p></div><div class=zs-modal-body><div class=zs-modal-btns><button class="btn btn-blink" data-num=2>2元</button>
<button class="btn btn-blink" data-num=5>5元</button>
<button class="btn btn-blink" data-num=10>10元</button>
<button class="btn btn-blink" data-num=50>50元</button>
<button class="btn btn-blink" data-num=100>100元</button>
<button class="btn btn-blink" data-num=1>任意金额</button></div><div class=zs-modal-pay><button class="btn btn-bred" id=pay-text>2元</button><p>使用<span id=pay-type>微信</span>扫描二维码完成支付</p><img src=/hugo-template/img/reward/wechat-2.png id=pay-image></div></div><div class=zs-modal-footer><label><input type=radio name=zs-type value=wechat class=zs-type checked><span><span class=zs-wechat><img src=/hugo-template/img/reward/wechat-btn.png></span></label>
<label><input type=radio name=zs-type value=alipay class=zs-type class=zs-alipay><img src=/hugo-template/img/reward/alipay-btn.png></span></label></div></div><script type=text/javascript src=/hugo-template/js/reward.js></script><hr><ul class=pager><li class=previous><a href=/hugo-template/post/2024-05-17-client-ip-en/ data-toggle=tooltip data-placement=top title="How to Get the Client’s “Real” IP Address with Envoy Gateway ?">&larr;
Previous Post</a></li><li class=next><a href=/hugo-template/post/2024-06-16-eg-1.1.0-english/ data-toggle=tooltip data-placement=top title="Highlights of Envoy Gateway v1.1.0: What’s New and Improved">Next
Post &rarr;</a></li></ul><link href=https://xxx.xxx.com/dist/Artalk.css rel=stylesheet><script src=https://xxx.xxx.com/dist/Artalk.js></script><div id=Comments></div><script>Artalk.init({el:"#Comments",pageKey:"https://lopins.github.io/hugo-template/post/2024-06-16-eg-1.1.0/",pageTitle:"Envoy Gateway v 1.1.0 版本发布：新功能与改进介绍",server:"https://xxx.xxx.com",site:"xxx blog"})</script></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5><a href=/tags/>FEATURED TAGS</a></h5><div class=tags><a href=/tags/aeraki title=aeraki>aeraki
</a><a href=/tags/aeraki-mesh title="aeraki mesh">aeraki mesh
</a><a href=/tags/ambient-mesh title="ambient mesh">ambient mesh
</a><a href=/tags/api-gateway title="api gateway">api gateway
</a><a href=/tags/bitcoin title=bitcoin>bitcoin
</a><a href=/tags/blockchain title=blockchain>blockchain
</a><a href=/tags/cka title=cka>cka
</a><a href=/tags/cncf title=cncf>cncf
</a><a href=/tags/cryptocurrency title=cryptocurrency>cryptocurrency
</a><a href=/tags/digital-signature title="digital signature">digital signature
</a><a href=/tags/docker title=docker>docker
</a><a href=/tags/dubbo title=dubbo>dubbo
</a><a href=/tags/envoy title=envoy>envoy
</a><a href=/tags/envoy-gateway title="envoy gateway">envoy gateway
</a><a href=/tags/ingress title=ingress>ingress
</a><a href=/tags/istio title=istio>istio
</a><a href=/tags/jaeger title=jaeger>jaeger
</a><a href=/tags/kafka title=kafka>kafka
</a><a href=/tags/knowledge-graph title="knowledge graph">knowledge graph
</a><a href=/tags/kubecon title=kubecon>kubecon
</a><a href=/tags/kubernetes title=kubernetes>kubernetes
</a><a href=/tags/linux title=linux>linux
</a><a href=/tags/loadbalancer title=loadbalancer>loadbalancer
</a><a href=/tags/metaprotocol title=metaprotocol>metaprotocol
</a><a href=/tags/microservice title=microservice>microservice
</a><a href=/tags/network title=network>network
</a><a href=/tags/network-service-mesh title="network service mesh">network service mesh
</a><a href=/tags/nfv title=nfv>nfv
</a><a href=/tags/nodeport title=nodeport>nodeport
</a><a href=/tags/onap title=onap>onap
</a><a href=/tags/opentracing title=opentracing>opentracing
</a><a href=/tags/pilot title=pilot>pilot
</a><a href=/tags/proxy-protocol title="proxy protocol">proxy protocol
</a><a href=/tags/redis title=redis>redis
</a><a href=/tags/sdn title=sdn>sdn
</a><a href=/tags/security title=security>security
</a><a href=/tags/service-mesh title="service mesh">service mesh
</a><a href=/tags/tencent title=tencent>tencent
</a><a href=/tags/x-forwarded-for title=x-forwarded-for>x-forwarded-for</a></div></section><section><hr><h5>FRIENDS</h5><ul class=list-inline><li><a target=_blank href=https://zhaozhihan.com>Linda的博客</a></li></ul></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:youremail@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=/hugo-template/your%20wechat%20qr%20code%20image><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-weixin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/yourgithub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://www.linkedin.com/in/yourlinkedinid><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://stackoverflow.com/users/yourstackoverflowid><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li><li><a href rel=alternate type=application/rss+xml title="Huabing Blog"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; Huabing Blog 2024<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://zhaohuabing.com>Huabing</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe></p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,a=$(_containerSelector),r=a.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),r.each(function(){t=$(this).prop("tagName").toLowerCase(),o="#"+$(this).prop("id"),n=$(this).text(),i=$('<a href="'+o+'" rel="nofollow">'+n+"</a>"),s=$('<li class="'+t+'_nav"></li>').append(i),$(e).append(s)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/hugo-template/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>