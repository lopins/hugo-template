<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="Huabing Blog"><meta property="og:type" content="article"><meta property="og:image" content="https://images.unsplash.com/photo-1558403871-bb6e8113a32e?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2662&amp;q=80"><meta property="twitter:image" content="https://images.unsplash.com/photo-1558403871-bb6e8113a32e?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2662&amp;q=80"><meta name=title content="Try out Istio Ambient mode"><meta property="og:title" content="Try out Istio Ambient mode"><meta property="twitter:title" content="Try out Istio Ambient mode"><meta name=description content="赵化冰，程序员, 开源爱好者，生活探险家 | 这里是 赵化冰 的博客，与你一起发现更大的世界。"><meta property="og:description" content="赵化冰，程序员, 开源爱好者，生活探险家 | 这里是 赵化冰 的博客，与你一起发现更大的世界。"><meta property="twitter:description" content="赵化冰，程序员, 开源爱好者，生活探险家 | 这里是 赵化冰 的博客，与你一起发现更大的世界。"><meta property="twitter:card" content="summary"><meta name=keyword content="赵化冰, zhaohuabing, Zhaohuabing, , 赵化冰的网络日志, 赵化冰的博客, Zhaohuabing Blog, 博客, 个人网站, 互联网, Web, 云原生, PaaS, Istio, Kubernetes, 微服务, Microservice"><link rel="shortcut icon" href=/hugo-template/img/favicon.ico><title>Try out Istio Ambient mode | 赵化冰的博客 | Zhaohuabing Blog</title>
<link rel=canonical href=/hugo-template/post/2022-09-10-try-istio-ambient-english/><link rel=stylesheet href=/hugo-template/css/bootstrap.min.css><link rel=stylesheet href=/hugo-template/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/hugo-template/css/zanshang.css><link rel=stylesheet href=/hugo-template/css/font-awesome.all.min.css><script src=/hugo-template/js/jquery.min.js></script><script src=/hugo-template/js/bootstrap.min.js></script><script src=/hugo-template/js/hux-blog.min.js></script><script src=/hugo-template/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=/>Huabing Blog</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/hugo-template/categories/books/>books</a></li><li><a href=/hugo-template/categories/open-source/>open source</a></li><li><a href=/hugo-template/categories/presentations/>presentations</a></li><li><a href=/hugo-template/categories/tech/>tech</a></li><li><a href=/archive//>ARCHIVE</a></li><li><a href=/notes//>NOTES</a></li><li><a href=/about//>ABOUT</a></li><li><a href=/hugo-template/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(https://images.unsplash.com/photo-1558403871-bb6e8113a32e?ixlib=rb-1.2.1&ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&auto=format&fit=crop&w=2662&q=80)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/istio title=Istio>Istio
</a><a class=tag href=/tags/envoy title=Envoy>Envoy
</a><a class=tag href=/tags/service-mesh title="Service Mesh">Service Mesh
</a><a class=tag href=/tags/ambient-mesh title="Ambient Mesh">Ambient Mesh</a></div><h1>Try out Istio Ambient mode</h1><h2 class=subheading></h2><span class=meta>Posted by
Huaing Zhao
on
Saturday, September 10, 2022</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p>Ambient is a new data-plane model that Istio has just announced support for. In this post, we will try to install Istio’s ambient model and use the bookinfo demo to experience the L4 and L7 capabilities offered by ambient.</p><blockquote><p>Note: L4 refers to the four layers of the OSI standard network model, i.e., TCP layer processing. L7 refers to layer seven of the OSI standard network model, which is the application layer processing, generally referred to as HTTP protocol processing.</p></blockquote><h1 id=install-istio-ambient-mode>Install Istio ambient mode</h1><p>According to the ambient <a href=https://github.com/istio/istio/tree/experimental-ambient#readme>README</a>，ambient currently supports Google GKE, AWS EKS and kind k8s deployment environments . After my experimentation, kind on Ubuntu is the most convenient deployment environment to try ambient. You can refer to<a href=https://istio.io/latest/blog/2022/get-started-ambient/>Get Started with Istio Ambient Mesh</a> to deploy the Istio experiment version with ambient support. If you do not have access to the official download address, you can download and install from the mirror I built in China by following these steps:</p><ol><li><p>First install docker and <a href=https://kind.sigs.k8s.io/docs/user/quick-start/>kind</a> on an Ubuntu virtual machine.</p></li><li><p>Create a kind k8s cluster:</p></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kind create cluster --config<span style=color:#ff79c6>=</span>- <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>kind: Cluster
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>apiVersion: kind.x-k8s.io/v1alpha4
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>name: ambient
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>nodes:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>- role: control-plane
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>- role: worker
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>- role: worker
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div><ol start=3><li>Then download and unzip the Istio experiment version that supports ambient mode.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget https://zhaohuabing.com/download/ambient/istio-0.0.0-ambient.191fe680b52c1754ee72a06b3e0d3f9d116f2e82-linux-amd64.tar.gz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tar -xvf istio-0.0.0-ambient.191fe680b52c1754ee72a06b3e0d3f9d116f2e82-linux-amd64.tar.gz
</span></span></code></pre></div><ol start=4><li>Install Istio, you need to specify the profile as ambient, note that you need to specify the hub if you can&rsquo;t access gcr.io, otherwise the relevant container image may fail to pull due to network reasons.</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>cd</span> istio-0.0.0-ambient.191fe680b52c1754ee72a06b3e0d3f9d116f2e82
</span></span><span style=display:flex><span>./bin/istioctl install --set <span style=color:#8be9fd;font-style:italic>profile</span><span style=color:#ff79c6>=</span>ambient --set <span style=color:#8be9fd;font-style:italic>hub</span><span style=color:#ff79c6>=</span>zhaohuabing
</span></span></code></pre></div><p>The ambient profile installs Istiod, ingress gateway, ztunnel and istio-cni components in the cluster. The ztunnel and istio-cni are deployed on each node as daemonset. istio-cni is used to detect which application pods are in ambient mode and create iptables rules to redirect outbound and inbound traffic from these pods to the node’s ztunnel. istio-cni will continuously monitors changes to the pods on the node and updates the redirection logic accordingly.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n istio-system get pod
</span></span><span style=display:flex><span>NAME                                    READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>istio-cni-node-27f9k                    1/1     Running   <span style=color:#bd93f9>0</span>          85m
</span></span><span style=display:flex><span>istio-cni-node-nxcnf                    1/1     Running   <span style=color:#bd93f9>0</span>          85m
</span></span><span style=display:flex><span>istio-cni-node-x2kjz                    1/1     Running   <span style=color:#bd93f9>0</span>          85m
</span></span><span style=display:flex><span>istio-ingressgateway-5c87575d87-5chhx   1/1     Running   <span style=color:#bd93f9>0</span>          85m
</span></span><span style=display:flex><span>istiod-bdddf595b-tn9px                  1/1     Running   <span style=color:#bd93f9>0</span>          87m
</span></span><span style=display:flex><span>ztunnel-5nnnl                           1/1     Running   <span style=color:#bd93f9>0</span>          87m
</span></span><span style=display:flex><span>ztunnel-dk42c                           1/1     Running   <span style=color:#bd93f9>0</span>          87m
</span></span><span style=display:flex><span>ztunnel-ff26n                           1/1     Running   <span style=color:#bd93f9>0</span>          87m
</span></span></code></pre></div><h1 id=deploy-the-demo-application>Deploy the demo application</h1><p>Execute the following command to deploy the Demo application:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f samples/bookinfo/platform/kube/bookinfo.yaml
</span></span><span style=display:flex><span>kubectl apply -f samples/bookinfo/networking/bookinfo-gateway.yaml
</span></span><span style=display:flex><span>kubectl apply -f https://zhaohuabing.com/download/ambient/sleep.yaml
</span></span><span style=display:flex><span>kubectl apply -f https://zhaohuabing.com/download/ambient/notsleep.yaml
</span></span></code></pre></div><p>The above command deploys the demo application in the default namespace. Currently, the traffic of the demo application does not go through ztunnel, and the traffic between pods goes through the <a href=https://www.zhaohuabing.com/post/2019-03-29-how-to-choose-ingress-for-service-mesh/#undefined>k8s service</a> mechanism to communicat with each other, and the traffic between pods is not protected by mTLS.</p><p><img src=https://zhaohuabing.com/static/img/2022-09-10-try-istio-ambient/app-not-in-ambient.png alt></p><h1 id=put-demo-application-in-ambient-mode>Put demo application in ambient mode</h1><p>You can add all application workloads in a namespace to the ambient mesh by labeling the namespace with the following tag.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl label namespace default istio.io/dataplane-mode<span style=color:#ff79c6>=</span>ambient
</span></span></code></pre></div><p>The istio-cni component watches the namespace added to the ambient mesh and will set the appropriate traffic redirection policy. If we check the istio-cni logs, we can see that istio-cni creates the appropriate routing rules for the application pod.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl logs istio-cni-node-nxcnf -n istio-system|grep route
</span></span><span style=display:flex><span>2022-09-10T09:40:07.371761Z	info	ambient	Adding route <span style=color:#ff79c6>for</span> reviews-v3-75f494fccb-gh9sr/default: <span style=color:#ff79c6>[</span>table <span style=color:#bd93f9>100</span> 10.244.2.8/32 via 192.168.126.2 dev istioin src 10.244.2.1<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>2022-09-10T09:40:07.375442Z	info	ambient	Adding route <span style=color:#ff79c6>for</span> productpage-v1-7c548b785b-kxdwz/default: <span style=color:#ff79c6>[</span>table <span style=color:#bd93f9>100</span> 10.244.2.9/32 via 192.168.126.2 dev istioin src 10.244.2.1<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>2022-09-10T09:40:07.379072Z	info	ambient	Adding route <span style=color:#ff79c6>for</span> details-v1-76778d6644-cvkc7/default: <span style=color:#ff79c6>[</span>table <span style=color:#bd93f9>100</span> 10.244.2.4/32 via 192.168.126.2 dev istioin src 10.244.2.1<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>2022-09-10T09:40:07.382887Z	info	ambient	Adding route <span style=color:#ff79c6>for</span> ratings-v1-85c74b6cb4-rzn44/default: <span style=color:#ff79c6>[</span>table <span style=color:#bd93f9>100</span> 10.244.2.5/32 via 192.168.126.2 dev istioin src 10.244.2.1<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>2022-09-10T09:40:07.386015Z	info	ambient	Adding route <span style=color:#ff79c6>for</span> reviews-v1-6494d87c7b-f4lvz/default: <span style=color:#ff79c6>[</span>table <span style=color:#bd93f9>100</span> 10.244.2.6/32 via 192.168.126.2 dev istioin src 10.244.2.1<span style=color:#ff79c6>]</span>
</span></span><span style=display:flex><span>2022-09-10T09:40:07.389121Z	info	ambient	Adding route <span style=color:#ff79c6>for</span> reviews-v2-79857b95b-nk8hn/default: <span style=color:#ff79c6>[</span>table <span style=color:#bd93f9>100</span> 10.244.2.7/32 via 192.168.126.2 dev istioin src 10.244.2.1<span style=color:#ff79c6>]</span>
</span></span></code></pre></div><p>Access the productpage from sleep:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl <span style=color:#8be9fd;font-style:italic>exec</span> deploy/sleep -- curl -s http://productpage:9080/ 
</span></span></code></pre></div><p>We should be able to see the output of the productpage service. At this point the traffic has been authenticated and encrypted in both directions with mTLS via ztunnel. We should be able to see the access logs from the ztunnel on the sleep and productpage nodes.</p><p>Traffic in the outbound direction (sleep -> ztunnel on the sleep node).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl  -n istio-system logs ztunnel-dk42c -cistio-proxy --tail <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>2022-09-10T10:12:33.041Z<span style=color:#ff79c6>]</span> <span style=color:#f1fa8c>&#34;- - -&#34;</span> <span style=color:#bd93f9>0</span> - - - <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#bd93f9>84</span> <span style=color:#bd93f9>1839</span> <span style=color:#bd93f9>2</span> - <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#f1fa8c>&#34;envoy://outbound_tunnel_lis_spiffe://cluster.local/ns/default/sa/sleep/10.244.2.9:9080&#34;</span> spiffe://cluster.local/ns/default/sa/sleep_to_http_productpage.default.svc.cluster.local_outbound_internal envoy://internal_client_address/ 10.96.250.29:9080 10.244.1.5:45176 - - capture outbound <span style=color:#ff79c6>(</span>no waypoint proxy<span style=color:#ff79c6>)</span>
</span></span></code></pre></div><p>Traffic logs in the inbound direction (ztunnel -> productpage on productpage).</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl  -n istio-system logs ztunnel-ff26n -cistio-proxy --tail <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>2022-09-10T10:18:23.497Z<span style=color:#ff79c6>]</span> <span style=color:#f1fa8c>&#34;CONNECT - HTTP/2&#34;</span> <span style=color:#bd93f9>200</span> - via_upstream - <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#bd93f9>84</span> <span style=color:#bd93f9>1839</span> <span style=color:#bd93f9>2</span> - <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#f1fa8c>&#34;6300b128-3a4d-472e-b573-e14743b6c981&#34;</span> <span style=color:#f1fa8c>&#34;10.244.2.9:9080&#34;</span> <span style=color:#f1fa8c>&#34;10.244.2.9:9080&#34;</span> virtual_inbound 10.244.1.3:48053 10.244.2.9:15008 10.244.1.3:36748 - - inbound hcm
</span></span></code></pre></div><p>We can see that the outbound traffic log has the word (no waypoint proxy) in it because ambient’s only does L4 processing by default, no L7 processing. The traffic only goes through the ztunnel and not the waypoint proxy, as shown in the figure below.</p><p><img src=https://zhaohuabing.com/static/img/2022-09-10-try-istio-ambient/app-in-ambient-secure-overlay.png alt></p><h1 id=enable-l7-processing-for-ambient-mode>Enable L7 processing for ambient mode</h1><p>Currently ambient mode requires a gateway to be defined to enable L7 processing for a service. Create the following gateway to enable L7 processing for the productpage service.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f - <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>metadata:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c> name: productpage
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c> annotations:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>   istio.io/service-account: bookinfo-productpage
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>spec:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c> gatewayClassName: istio-mesh
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div><p>Note that the gatewayClassName in the gateway resource must be set to ‘istio-mesh’, otherwise Istio won&rsquo;t create the corresponding waypoint proxy for the productpage.</p><p>You can see the waypoint proxy created by Istio at this point.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl get pod|grep waypoint
</span></span><span style=display:flex><span>bookinfo-productpage-waypoint-proxy-7dc7c7ff6-6q6l7   1/1     Running   <span style=color:#bd93f9>0</span>          21s
</span></span></code></pre></div><p>Access the productpage from sleep.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl <span style=color:#8be9fd;font-style:italic>exec</span> deploy/sleep -- curl -s http://productpage:9080/ 
</span></span></code></pre></div><p>Let’s look at the actual path that the request goes through.</p><p>sleep -> ztunnel on sleep node.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl  -n istio-system logs ztunnel-dk42c -cistio-proxy --tail <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>2022-09-10T10:51:36.373Z<span style=color:#ff79c6>]</span> <span style=color:#f1fa8c>&#34;- - -&#34;</span> <span style=color:#bd93f9>0</span> - - - <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#bd93f9>84</span> <span style=color:#bd93f9>1894</span> <span style=color:#bd93f9>5</span> - <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#f1fa8c>&#34;10.244.2.12:15006&#34;</span> spiffe://cluster.local/ns/default/sa/sleep_to_server_waypoint_proxy_spiffe://cluster.local/ns/default/sa/bookinfo-productpage 10.244.1.5:47829 10.96.250.29:9080 10.244.1.5:44952 - - capture outbound <span style=color:#ff79c6>(</span>to server waypoint proxy<span style=color:#ff79c6>)</span>
</span></span></code></pre></div><p>You can see the words (to server waypoint proxy) in the above log, indicating that the request went through the waypoint proxy.</p><p>ztunnel on sleepnode-> waypoint proxy.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl logs bookinfo-productpage-waypoint-proxy-7dc7c7ff6-6q6l7 --tail <span style=color:#bd93f9>3</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>2022-09-10T10:51:36.375Z<span style=color:#ff79c6>]</span> <span style=color:#f1fa8c>&#34;GET / HTTP/1.1&#34;</span> <span style=color:#bd93f9>200</span> - via_upstream - <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>1683</span> <span style=color:#bd93f9>2</span> <span style=color:#bd93f9>2</span> <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#f1fa8c>&#34;curl/7.85.0-DEV&#34;</span> <span style=color:#f1fa8c>&#34;fe3ba798-4ace-4891-b919-c3ea924f8cb9&#34;</span> <span style=color:#f1fa8c>&#34;productpage:9080&#34;</span> <span style=color:#f1fa8c>&#34;envoy://inbound_CONNECT_originate/10.244.2.9:9080&#34;</span> inbound-pod|9080<span style=color:#ff79c6>||</span>10.244.2.9 envoy://internal_client_address/ envoy://inbound-pod|9080<span style=color:#ff79c6>||</span>10.244.2.9/ envoy://internal_client_address/ - default
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>2022-09-10T10:51:36.374Z<span style=color:#ff79c6>]</span> <span style=color:#f1fa8c>&#34;GET / HTTP/1.1&#34;</span> <span style=color:#bd93f9>200</span> - via_upstream - <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#bd93f9>0</span> <span style=color:#bd93f9>1683</span> <span style=color:#bd93f9>3</span> <span style=color:#bd93f9>3</span> <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#f1fa8c>&#34;curl/7.85.0-DEV&#34;</span> <span style=color:#f1fa8c>&#34;fe3ba798-4ace-4891-b919-c3ea924f8cb9&#34;</span> <span style=color:#f1fa8c>&#34;productpage:9080&#34;</span> <span style=color:#f1fa8c>&#34;envoy://inbound-pod|9080||10.244.2.9/&#34;</span> inbound-vip|9080|http|productpage.default.svc.cluster.local envoy://internal_client_address/ envoy://inbound-vip|9080<span style=color:#ff79c6>||</span>productpage.default.svc.cluster.local/ envoy://internal_client_address/ - default
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>2022-09-10T10:51:36.374Z<span style=color:#ff79c6>]</span> <span style=color:#f1fa8c>&#34;CONNECT - HTTP/2&#34;</span> <span style=color:#bd93f9>200</span> - via_upstream - <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#bd93f9>84</span> <span style=color:#bd93f9>1894</span> <span style=color:#bd93f9>4</span> - <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#f1fa8c>&#34;eb705930-8b73-4c29-870e-ead523143278&#34;</span> <span style=color:#f1fa8c>&#34;10.96.250.29:9080&#34;</span> <span style=color:#f1fa8c>&#34;envoy://inbound-vip|9080||productpage.default.svc.cluster.local/&#34;</span> inbound-vip|9080|internal|productpage.default.svc.cluster.local envoy://internal_client_address/ 10.244.2.12:15006 10.244.1.5:47829 - -
</span></span></code></pre></div><p>productpage node 上的 ztunnel -> productpage</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl  -n istio-system logs ztunnel-ff26n -cistio-proxy --tail <span style=color:#bd93f9>1</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>[</span>2022-09-10T10:51:36.376Z<span style=color:#ff79c6>]</span> <span style=color:#f1fa8c>&#34;CONNECT - HTTP/2&#34;</span> <span style=color:#bd93f9>200</span> - via_upstream - <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#bd93f9>699</span> <span style=color:#bd93f9>1839</span> <span style=color:#bd93f9>1</span> - <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#f1fa8c>&#34;-&#34;</span> <span style=color:#f1fa8c>&#34;3e0eaa80-7c72-4d46-909a-233a6bd6073e&#34;</span> <span style=color:#f1fa8c>&#34;10.244.2.9:9080&#34;</span> <span style=color:#f1fa8c>&#34;10.244.2.9:9080&#34;</span> virtual_inbound 10.244.2.12:41893 10.244.2.9:15008 10.244.2.12:38336 - - inbound hcm
</span></span></code></pre></div><p>After the L7 feature has been enabled in ambient mode, the traffic path between applications is shown in the figure below.
<img src=https://zhaohuabing.com/static/img/2022-09-10-try-istio-ambient/app-in-ambient-l7.png alt></p><h1 id=routing-traffic>Routing Traffic</h1><p>Now let’s try to route the traffic in ambient mode. Ambient mode has the same routing rules as sidecar mode and also uses Virtual service.</p><p>First enable the L7 capability for the review service by creating a gateway.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f - <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>apiVersion: gateway.networking.k8s.io/v1alpha2
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>kind: Gateway
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>metadata:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c> name: reviews
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c> annotations:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>   istio.io/service-account: bookinfo-reviews
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>spec:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c> gatewayClassName: istio-mesh
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div><p>Creat a DR to divide the reviews service into 3 subsets.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f - <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>apiVersion: networking.istio.io/v1alpha3
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>kind: DestinationRule
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>metadata:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  name: reviews
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>spec:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  host: reviews
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  trafficPolicy:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    loadBalancer:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      simple: RANDOM
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  subsets:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  - name: v1
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    labels:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      version: v1
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  - name: v2
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    labels:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      version: v2
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  - name: v3
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    labels:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      version: v3
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div><p>Create VS and send requests to V1 and V2 versions in 90/10 ratio.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f - <span style=color:#f1fa8c>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>apiVersion: networking.istio.io/v1alpha3
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>kind: VirtualService
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>metadata:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  name: reviews
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>spec:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  hosts:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    - reviews
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  http:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>  - route:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    - destination:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        host: reviews
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        subset: v1
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      weight: 90
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>    - destination:
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        host: reviews
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>        subset: v2
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>      weight: 10
</span></span></span><span style=display:flex><span><span style=color:#f1fa8c>EOF</span>
</span></span></code></pre></div><p>Execute the following command to verify that the reviews service requests are routed according to the routing rules defined above.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl <span style=color:#8be9fd;font-style:italic>exec</span> -it deploy/sleep -- sh -c <span style=color:#f1fa8c>&#39;for i in $(seq 1 10); do curl -s http://istio-ingressgateway.istio-system/productpage | grep reviews-v.-; done&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        &lt;u&gt;reviews-v2-79857b95b-nk8hn&lt;/u&gt;
</span></span><span style=display:flex><span>        &lt;u&gt;reviews-v1-6494d87c7b-f4lvz&lt;/u&gt;
</span></span><span style=display:flex><span>        &lt;u&gt;reviews-v1-6494d87c7b-f4lvz&lt;/u&gt;
</span></span><span style=display:flex><span>        &lt;u&gt;reviews-v1-6494d87c7b-f4lvz&lt;/u&gt;
</span></span><span style=display:flex><span>        &lt;u&gt;reviews-v1-6494d87c7b-f4lvz&lt;/u&gt;
</span></span><span style=display:flex><span>        &lt;u&gt;reviews-v1-6494d87c7b-f4lvz&lt;/u&gt;
</span></span><span style=display:flex><span>        &lt;u&gt;reviews-v1-6494d87c7b-f4lvz&lt;/u&gt;
</span></span><span style=display:flex><span>        &lt;u&gt;reviews-v1-6494d87c7b-f4lvz&lt;/u&gt;
</span></span><span style=display:flex><span>        &lt;u&gt;reviews-v1-6494d87c7b-f4lvz&lt;/u&gt;
</span></span><span style=display:flex><span>        &lt;u&gt;reviews-v1-6494d87c7b-f4lvz&lt;/u&gt;
</span></span></code></pre></div><h1 id=wrap-up-and-key-take-aways>Wrap-up and Key Take-aways</h1><p>From the above experiments, we can see that ambient mode has solved the deployment dependency problem of application and sidecar in Istio sidecar mode. In ambient mode, the service mesh functionalities are provided through ztunnel and waypoint proxy, which are outside of the application pod, and sidecar injection to the application pods is no longer required. As a result, the lifecycle of application and mesh components such as deployment and upgrade are no longer coupled, bringing the service mesh down to the infrastructure layer as it has promised.</p><p>Currently, to enable the L7 processing for a service, you have to create a gateway, which is an additional burden for operations. I was also concerned about the bigger blast radius compared with sidecar. But since a waypoint only serves a service account, this problem can be mitigated by assign a dedicated service account for each service, and it&rsquo;s also a k8s security best-practice we should follow.</p><p>Aywany, ambient is still in active development, so I believe these minor issues will be solved soon in future release.</p><h1 id=reference>Reference</h1><ul><li><a href=https://istio.io/latest/blog/2022/get-started-ambient/>https://istio.io/latest/blog/2022/get-started-ambient/</a></li></ul><div class="entry-shang text-center"><p>「真诚赞赏，手留余香」</p><button class="zs show-zs btn btn-bred">赞赏支持</button></div><div class=zs-modal-bg></div><div class=zs-modal-box><div class=zs-modal-head><button type=button class=close>×</button>
<span class=author><a href=https://lopins.github.io/hugo-template/><img src=/hugo-template/img/favicon.png>Huabing Blog</a></span><p class=tip><i></i><span>真诚赞赏，手留余香</span></p></div><div class=zs-modal-body><div class=zs-modal-btns><button class="btn btn-blink" data-num=2>2元</button>
<button class="btn btn-blink" data-num=5>5元</button>
<button class="btn btn-blink" data-num=10>10元</button>
<button class="btn btn-blink" data-num=50>50元</button>
<button class="btn btn-blink" data-num=100>100元</button>
<button class="btn btn-blink" data-num=1>任意金额</button></div><div class=zs-modal-pay><button class="btn btn-bred" id=pay-text>2元</button><p>使用<span id=pay-type>微信</span>扫描二维码完成支付</p><img src=/hugo-template/img/reward/wechat-2.png id=pay-image></div></div><div class=zs-modal-footer><label><input type=radio name=zs-type value=wechat class=zs-type checked><span><span class=zs-wechat><img src=/hugo-template/img/reward/wechat-btn.png></span></label>
<label><input type=radio name=zs-type value=alipay class=zs-type class=zs-alipay><img src=/hugo-template/img/reward/alipay-btn.png></span></label></div></div><script type=text/javascript src=/hugo-template/js/reward.js></script><hr><ul class=pager><li class=previous><a href=/hugo-template/post/2022-09-10-try-istio-ambient/ data-toggle=tooltip data-placement=top title="初探 Istio Ambient 模式">&larr;
Previous Post</a></li><li class=next><a href=/hugo-template/post/2022-09-27-aeraki-mesh-ngjg-use-case/ data-toggle=tooltip data-placement=top title="脑动极光 Aeraki Mesh Dubbo 架构微服务治理实践应用">Next
Post &rarr;</a></li></ul><link href=https://xxx.xxx.com/dist/Artalk.css rel=stylesheet><script src=https://xxx.xxx.com/dist/Artalk.js></script><div id=Comments></div><script>Artalk.init({el:"#Comments",pageKey:"https://lopins.github.io/hugo-template/post/2022-09-10-try-istio-ambient-english/",pageTitle:"Try out Istio Ambient mode",server:"https://xxx.xxx.com",site:"xxx blog"})</script></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5><a href=/tags/>FEATURED TAGS</a></h5><div class=tags><a href=/tags/aeraki title=aeraki>aeraki
</a><a href=/tags/aeraki-mesh title="aeraki mesh">aeraki mesh
</a><a href=/tags/ambient-mesh title="ambient mesh">ambient mesh
</a><a href=/tags/api-gateway title="api gateway">api gateway
</a><a href=/tags/bitcoin title=bitcoin>bitcoin
</a><a href=/tags/blockchain title=blockchain>blockchain
</a><a href=/tags/cka title=cka>cka
</a><a href=/tags/cncf title=cncf>cncf
</a><a href=/tags/cryptocurrency title=cryptocurrency>cryptocurrency
</a><a href=/tags/digital-signature title="digital signature">digital signature
</a><a href=/tags/docker title=docker>docker
</a><a href=/tags/dubbo title=dubbo>dubbo
</a><a href=/tags/envoy title=envoy>envoy
</a><a href=/tags/envoy-gateway title="envoy gateway">envoy gateway
</a><a href=/tags/ingress title=ingress>ingress
</a><a href=/tags/istio title=istio>istio
</a><a href=/tags/jaeger title=jaeger>jaeger
</a><a href=/tags/kafka title=kafka>kafka
</a><a href=/tags/knowledge-graph title="knowledge graph">knowledge graph
</a><a href=/tags/kubecon title=kubecon>kubecon
</a><a href=/tags/kubernetes title=kubernetes>kubernetes
</a><a href=/tags/linux title=linux>linux
</a><a href=/tags/loadbalancer title=loadbalancer>loadbalancer
</a><a href=/tags/metaprotocol title=metaprotocol>metaprotocol
</a><a href=/tags/microservice title=microservice>microservice
</a><a href=/tags/network title=network>network
</a><a href=/tags/network-service-mesh title="network service mesh">network service mesh
</a><a href=/tags/nfv title=nfv>nfv
</a><a href=/tags/nodeport title=nodeport>nodeport
</a><a href=/tags/onap title=onap>onap
</a><a href=/tags/opentracing title=opentracing>opentracing
</a><a href=/tags/pilot title=pilot>pilot
</a><a href=/tags/proxy-protocol title="proxy protocol">proxy protocol
</a><a href=/tags/redis title=redis>redis
</a><a href=/tags/sdn title=sdn>sdn
</a><a href=/tags/security title=security>security
</a><a href=/tags/service-mesh title="service mesh">service mesh
</a><a href=/tags/tencent title=tencent>tencent
</a><a href=/tags/x-forwarded-for title=x-forwarded-for>x-forwarded-for</a></div></section><section><hr><h5>FRIENDS</h5><ul class=list-inline><li><a target=_blank href=https://zhaozhihan.com>Linda的博客</a></li></ul></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:youremail@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=/hugo-template/your%20wechat%20qr%20code%20image><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-weixin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/yourgithub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://www.linkedin.com/in/yourlinkedinid><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://stackoverflow.com/users/yourstackoverflowid><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li><li><a href rel=alternate type=application/rss+xml title="Huabing Blog"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; Huabing Blog 2024<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://zhaohuabing.com>Huabing</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe></p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,a=$(_containerSelector),r=a.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),r.each(function(){t=$(this).prop("tagName").toLowerCase(),o="#"+$(this).prop("id"),n=$(this).text(),i=$('<a href="'+o+'" rel="nofollow">'+n+"</a>"),s=$('<li class="'+t+'_nav"></li>').append(i),$(e).append(s)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/hugo-template/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>