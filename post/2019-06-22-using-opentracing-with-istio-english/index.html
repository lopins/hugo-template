<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="Huabing Blog"><meta property="og:type" content="article"><meta property="og:image" content="https://zhaohuabing.com/static/img/2019-06-22-using-opentracing-with-istio/background.jpg"><meta property="twitter:image" content="https://zhaohuabing.com/static/img/2019-06-22-using-opentracing-with-istio/background.jpg"><meta name=title content="Enhance Istio Distributed Tracing with OpenTracing"><meta property="og:title" content="Enhance Istio Distributed Tracing with OpenTracing"><meta property="twitter:title" content="Enhance Istio Distributed Tracing with OpenTracing"><meta name=description content="赵化冰，程序员, 开源爱好者，生活探险家 | 这里是 赵化冰 的博客，与你一起发现更大的世界。"><meta property="og:description" content="赵化冰，程序员, 开源爱好者，生活探险家 | 这里是 赵化冰 的博客，与你一起发现更大的世界。"><meta property="twitter:description" content="赵化冰，程序员, 开源爱好者，生活探险家 | 这里是 赵化冰 的博客，与你一起发现更大的世界。"><meta property="twitter:card" content="summary"><meta name=keyword content="赵化冰, zhaohuabing, Zhaohuabing, , 赵化冰的网络日志, 赵化冰的博客, Zhaohuabing Blog, 博客, 个人网站, 互联网, Web, 云原生, PaaS, Istio, Kubernetes, 微服务, Microservice"><link rel="shortcut icon" href=/hugo-template/img/favicon.ico><title>Enhance Istio Distributed Tracing with OpenTracing | 赵化冰的博客 | Zhaohuabing Blog</title>
<link rel=canonical href=/hugo-template/post/2019-06-22-using-opentracing-with-istio-english/><link rel=stylesheet href=/hugo-template/css/bootstrap.min.css><link rel=stylesheet href=/hugo-template/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/hugo-template/css/zanshang.css><link rel=stylesheet href=/hugo-template/css/font-awesome.all.min.css><script src=/hugo-template/js/jquery.min.js></script><script src=/hugo-template/js/bootstrap.min.js></script><script src=/hugo-template/js/hux-blog.min.js></script><script src=/hugo-template/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=/>Huabing Blog</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/hugo-template/categories/books/>books</a></li><li><a href=/hugo-template/categories/open-source/>open source</a></li><li><a href=/hugo-template/categories/presentations/>presentations</a></li><li><a href=/hugo-template/categories/tech/>tech</a></li><li><a href=/archive//>ARCHIVE</a></li><li><a href=/notes//>NOTES</a></li><li><a href=/about//>ABOUT</a></li><li><a href=/hugo-template/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(https://zhaohuabing.com/static/img/2019-06-22-using-opentracing-with-istio/background.jpg)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/service-mesh title="Service Mesh">Service Mesh
</a><a class=tag href=/tags/istio title=Istio>Istio
</a><a class=tag href=/tags/opentracing title=Opentracing>Opentracing
</a><a class=tag href=/tags/jaeger title=Jaeger>Jaeger</a></div><h1>Enhance Istio Distributed Tracing with OpenTracing</h1><h2 class=subheading>Part 1: Implement Fine-grained Tracing with OpenTracing</h2><span class=meta>Posted by
    "赵化冰"
on
Saturday, August 24, 2019</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p>While evolving towards a microservices architecture, the biggest change is that the monolith application has been divided into multiple independent processes(or services), as a result, a method call between software modules now becomes a remote procedure call go through multiple services.</p><p>A client request usually goes through a couple of or even a dozen of services in a complex microservices system, which makes it really hard to figure out what’s going on when a request fails or becomes slow.</p><p><img src=https://zhaohuabing.com/static/img/2019-06-22-using-opentracing-with-istio/monolith-microserivce.jpg alt>
Basically, in order to get the overall view of a client request, we need to collect all the related information of service invocations in the path of that request, including start time, end time, URL, errors, etc., and associate all the collected data within a single trace. This process is normally called distributed tracing.</p><h1 id=distributed-tracing-with-istio>Distributed Tracing with Istio</h1><p>Istio/Envoy provides out-of-the-box distributed tracing for microservices. Envoy can intercept the incoming and outgoing requests of the service in the same pod and automatically generates tracing data for them. By connecting the mesh with a tracing infrastructure backend such as Zipkin or Jaeger, you can get the trace details of a distributed request, such as which services a request went through, which REST APIs were called, and the latency of each span, etc.</p><p>It should be noted that although Istio/Envoy has done most of the work in this process, it still requires a small amount of modification to the application code: the application code needs to propagate the tracing header in the upstream HTTP requests to its downstream services. This part of the code can’t be handled directly by Envoy because Envoy just doesn&rsquo;t understand the business logic of the service co-located with it, and therefore it can’t infer the affiliation of incoming requests with the outgoing requests correctly. Although the modification is a minor change, it needs to be added manually to every piece of code where a request is forwarding to a downstream service, which is annoying.</p><p>Let’s use a simple online shop demo to show how Istio provides distributed tracing. The demo consists of several services: eshop, inventory, billing, and delivery. The structure of the application is shown in the following figure:</p><p><img src=https://zhaohuabing.com/static/img/2019-06-22-using-opentracing-with-istio/eshop-demo.jpg alt>
eshop service accepts requests from the client sides, then it calls the REST APIs of inventory, billing, delivery services to accomplish the checkout user request.</p><p>Codes can be downloaded from Github: <a href=https://github.com/zhaohuabing/istio-opentracing-demo.git>https://github.com/zhaohuabing/istio-opentracing-demo.git</a></p><p>Below is the implementation of the checkout function of eshop Service, as you can see, tracing related HTTP Headers are propagated to downstream services.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span> @RequestMapping(value <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;/checkout&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> String <span style=color:#50fa7b>checkout</span>(@RequestHeader HttpHeaders headers) {
</span></span><span style=display:flex><span>    String result <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;&#34;</span>;
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Use HTTP GET in this demo. In a real world use case,We should use HTTP POST</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// instead.</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// The three services are bundled in one jar for simplicity. To make it work,</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// define three services in Kubernets.</span>
</span></span><span style=display:flex><span>    result <span style=color:#ff79c6>+=</span> restTemplate.<span style=color:#50fa7b>exchange</span>(<span style=color:#f1fa8c>&#34;http://inventory:8080/createOrder&#34;</span>, HttpMethod.<span style=color:#50fa7b>GET</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>new</span> HttpEntity<span style=color:#ff79c6>&lt;&gt;</span>(passTracingHeader(headers)), String.<span style=color:#50fa7b>class</span>).<span style=color:#50fa7b>getBody</span>();
</span></span><span style=display:flex><span>    result <span style=color:#ff79c6>+=</span> <span style=color:#f1fa8c>&#34;&lt;BR&gt;&#34;</span>;
</span></span><span style=display:flex><span>    result <span style=color:#ff79c6>+=</span> restTemplate.<span style=color:#50fa7b>exchange</span>(<span style=color:#f1fa8c>&#34;http://billing:8080/payment&#34;</span>, HttpMethod.<span style=color:#50fa7b>GET</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>new</span> HttpEntity<span style=color:#ff79c6>&lt;&gt;</span>(passTracingHeader(headers)), String.<span style=color:#50fa7b>class</span>).<span style=color:#50fa7b>getBody</span>();
</span></span><span style=display:flex><span>    result <span style=color:#ff79c6>+=</span> <span style=color:#f1fa8c>&#34;&lt;BR&gt;&#34;</span>;
</span></span><span style=display:flex><span>    result <span style=color:#ff79c6>+=</span> restTemplate.<span style=color:#50fa7b>exchange</span>(<span style=color:#f1fa8c>&#34;http://delivery:8080/arrangeDelivery&#34;</span>, HttpMethod.<span style=color:#50fa7b>GET</span>,
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>new</span> HttpEntity<span style=color:#ff79c6>&lt;&gt;</span>(passTracingHeader(headers)), String.<span style=color:#50fa7b>class</span>).<span style=color:#50fa7b>getBody</span>();
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> result;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>private</span> HttpHeaders <span style=color:#50fa7b>passTracingHeader</span>(HttpHeaders headers) {
</span></span><span style=display:flex><span>    HttpHeaders tracingHeaders <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HttpHeaders();
</span></span><span style=display:flex><span>    extractHeader(headers, tracingHeaders, <span style=color:#f1fa8c>&#34;x-request-id&#34;</span>);
</span></span><span style=display:flex><span>    extractHeader(headers, tracingHeaders, <span style=color:#f1fa8c>&#34;x-b3-traceid&#34;</span>);
</span></span><span style=display:flex><span>    extractHeader(headers, tracingHeaders, <span style=color:#f1fa8c>&#34;x-b3-spanid&#34;</span>);
</span></span><span style=display:flex><span>    extractHeader(headers, tracingHeaders, <span style=color:#f1fa8c>&#34;x-b3-parentspanid&#34;</span>);
</span></span><span style=display:flex><span>    extractHeader(headers, tracingHeaders, <span style=color:#f1fa8c>&#34;x-b3-sampled&#34;</span>);
</span></span><span style=display:flex><span>    extractHeader(headers, tracingHeaders, <span style=color:#f1fa8c>&#34;x-b3-flags&#34;</span>);
</span></span><span style=display:flex><span>    extractHeader(headers, tracingHeaders, <span style=color:#f1fa8c>&#34;x-ot-span-context&#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> tracingHeaders;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Then let’s deploy the demo in a Kubernetes cluster along with Istio.</p><ul><li>First, we need a Kubernetes cluster with Webhook enabled</li><li>Deploy Istio in the Kubernetes cluster, and enable sidecar auto-injection for the default namespace</li><li>Deploy eshop application</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/zhaohuabing/istio-opentracing-demo.git
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>cd</span> istio-opentracing-demo
</span></span><span style=display:flex><span>git checkout without-opentracing
</span></span><span style=display:flex><span>kubectl apply -f k8s/eshop.yaml
</span></span></code></pre></div><ul><li>Open this URL in your browser to invoke eshop checkout REST API: http://${NODE_IP}:31380/checkout</li><li>Open Jaeger UI to see the trace: http://${NODE_IP}:30088</li></ul><p>Note: In order to access Jaeger UI from outside of the Kubernetes Cluster, you may want to modify Istio install scripts to add a NodePort for Jaeger service:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: v1
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>kind</span>: Service
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>name</span>: jaeger-query
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>namespace</span>: istio-system
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>annotations</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>labels</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>app</span>: jaeger
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>jaeger-infra</span>: jaeger-service
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>chart</span>: tracing
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>heritage</span>: Tiller
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>release</span>: istio
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ff79c6>name</span>: query-http
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>port</span>: <span style=color:#bd93f9>16686</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>protocol</span>: TCP
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>targetPort</span>: <span style=color:#bd93f9>16686</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>nodePort</span>: <span style=color:#bd93f9>30088</span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>type</span>: NodePort
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>selector</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>app</span>: jaeger
</span></span></code></pre></div><p>As you can see, Istio/Envoy automatically generates a trace for the client request. The trace is comprised of several spans, and each span corresponds a REST method of a service in the chain of services invoked by the client request.</p><p><img src=https://zhaohuabing.com/static/img/2019-06-22-using-opentracing-with-istio/istio-tracing.jpg alt></p><h1 id=using-opentracing-for-trace-context-propagation>Using Opentracing for Trace Context Propagation</h1><p>Instead of explicitly passing the HTTP headers, we can use Opentracing instrumentation for trace Context propagation. It’s pretty simple：</p><ul><li>Add Opentracing Spring Cloud Starter and Jaeger dependency in the maven POM file.</li><li>Declare a tracer bean in the spring application.</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Bean
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> Tracer <span style=color:#50fa7b>jaegerTracer</span>() {
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// The following environment variables need to set</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// JAEGER_ENDPOINT=&#34;http://10.42.126.171:28019/api/traces&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// JAEGER_PROPAGATION=&#34;b3&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// JAEGER_TRACEID_128BIT=&#34;true&#34; Use 128bit tracer id to be compatible with the</span>
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// trace id generated by istio/envoy</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> Configuration.<span style=color:#50fa7b>fromEnv</span>(<span style=color:#f1fa8c>&#34;eshop-opentracing&#34;</span>).<span style=color:#50fa7b>getTracer</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>There are two things that we need to pay attention:</p><ul><li>By default, the Jaeger tracer uses the uber-trace-id HTTP header format, which is not supported by Istio/Envoy. Therefore, we need to specify the b3 HTTP header format in environment variables to make it compatible with Istio/Envoy.</li><li>The Jaeger tracer uses a 64-bit trace id by default, while Istio/Envoy uses a 128-bit trace id. Therefore, we need to specify the trace id length as 128 bit in environment variables to be compatible with Istio/Envoy.</li></ul><p>Deploy the version of the demo application that uses Opentracing for trace context propagation.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git checkout master
</span></span><span style=display:flex><span>kubectl apply -f k8s/eshop.yaml
</span></span></code></pre></div><p><img src=https://zhaohuabing.com/static/img/2019-06-22-using-opentracing-with-istio/istio-tracing-opentracing.jpg alt></p><p>As you can see from the above figure, one interesting thing is that 7 more spans have been inserted to the trace. These spans are implicitly generated by Opentracing Spring instrumentation. They provide us with more detailed information about the request. From these news spans, we can infer that it only takes about 1 millisecond for Envoy to proxy the request, it’s a very short time and it has nearly no impact on the latency of the client request.</p><h1 id=adding-method-level-tracing-to-istio>Adding Method-Level Tracing to Istio</h1><p>The distributed tracing capability of Istio/Envoy can only capture the tracing span at the process boundaries, which would be good enough in most cases. However, for some services, we may want more fine-grained trace information for a better understanding of what happened inside a process, such as the latency caused by a method call or SQL insert. To accomplish that, we need to instrument the code where we need to collect tracing data and associate the collected tracing data with the trace created by Envoy, then, we can see all the spans in a single trace on the Jager UI.</p><p>AOP and Annotation can be used to simplify the instrumentation code. First, let’s define a Traced annotation and the corresponding AOP implementation logic:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Retention(RetentionPolicy.<span style=color:#50fa7b>RUNTIME</span>)
</span></span><span style=display:flex><span>@Target(ElementType.<span style=color:#50fa7b>METHOD</span>)
</span></span><span style=display:flex><span>@Documented
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> @interface Traced {
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Aspect
</span></span><span style=display:flex><span>@Component
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>TracingAspect</span> {
</span></span><span style=display:flex><span>    @Autowired
</span></span><span style=display:flex><span>    Tracer tracer;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Around(<span style=color:#f1fa8c>&#34;@annotation(com.zhaohuabing.demo.instrument.Traced)&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> Object <span style=color:#50fa7b>aroundAdvice</span>(ProceedingJoinPoint jp) <span style=color:#8be9fd;font-style:italic>throws</span> Throwable {
</span></span><span style=display:flex><span>        String class_name <span style=color:#ff79c6>=</span> jp.<span style=color:#50fa7b>getTarget</span>().<span style=color:#50fa7b>getClass</span>().<span style=color:#50fa7b>getName</span>();
</span></span><span style=display:flex><span>        String method_name <span style=color:#ff79c6>=</span> jp.<span style=color:#50fa7b>getSignature</span>().<span style=color:#50fa7b>getName</span>();
</span></span><span style=display:flex><span>        Span span <span style=color:#ff79c6>=</span> tracer.<span style=color:#50fa7b>buildSpan</span>(class_name <span style=color:#ff79c6>+</span> <span style=color:#f1fa8c>&#34;.&#34;</span> <span style=color:#ff79c6>+</span> method_name).<span style=color:#50fa7b>withTag</span>(<span style=color:#f1fa8c>&#34;class&#34;</span>, class_name)
</span></span><span style=display:flex><span>                .<span style=color:#50fa7b>withTag</span>(<span style=color:#f1fa8c>&#34;method&#34;</span>, method_name).<span style=color:#50fa7b>start</span>();
</span></span><span style=display:flex><span>        Object result <span style=color:#ff79c6>=</span> jp.<span style=color:#50fa7b>proceed</span>();
</span></span><span style=display:flex><span>        span.<span style=color:#50fa7b>finish</span>();
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>return</span> result;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Then add the Traced annotation to the methods we would like to trace:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Component
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>DBAccess</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    @Traced
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>save2db</span>() {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>            Thread.<span style=color:#50fa7b>sleep</span>((<span style=color:#8be9fd>long</span>) (Math.<span style=color:#50fa7b>random</span>() <span style=color:#ff79c6>*</span> 100));
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>            e.<span style=color:#50fa7b>printStackTrace</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Component
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>class</span> <span style=color:#50fa7b>BankTransaction</span> {
</span></span><span style=display:flex><span>    @Traced
</span></span><span style=display:flex><span>    <span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>transfer</span>() {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>            Thread.<span style=color:#50fa7b>sleep</span>((<span style=color:#8be9fd>long</span>) (Math.<span style=color:#50fa7b>random</span>() <span style=color:#ff79c6>*</span> 100));
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>catch</span> (InterruptedException e) {
</span></span><span style=display:flex><span>            e.<span style=color:#50fa7b>printStackTrace</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The output is shown in the figure below. You can see that two methods-level spans (transfer and save2db) have been inserted into the trace.</p><p><img src=https://zhaohuabing.com/static/img/2019-06-22-using-opentracing-with-istio/istio-tracing-opentracing-in-depth.jpg alt>
You can open the span to view the details of the method call, including the Java class name, the method name, etc. If needed, you can also add other useful information such as the exception stack in the tracing, it can be easily done by just modify TracingAspect code.</p><p><img src=https://zhaohuabing.com/static/img/2019-06-22-using-opentracing-with-istio/istio-tracing-opentracing-in-depth-method.jpg alt></p><h1 id=wrapping-up>Wrapping up</h1><p>Istio gives you deep insight into your service mesh by its build-in distribute tracing capabilities. In this blog, we explored how we could leverage Opentracing to propagate tracing header for Istio and how to get more fine-grained tracing by inserted method-level spans into the Istio generated trace.</p><h1 id=whats-next>What’s next</h1><p>Async messaging is also a very common mechanism for microservice communication, however, Istio hasn&rsquo;t addressed that for now. In the next post, we’ll take a look at how to trace Kafka messages with the help of Opentracing in an Istio service mesh. Stay tuned!</p><h1 id=references>References</h1><ol><li><a href=https://github.com/zhaohuabing/istio-opentracing-demo>Source Code</a></li><li><a href=https://opentracing.io/docs/>Opentracing docs</a></li><li><a href=https://github.com/opentracing/specification/blob/master/specification.md>Opentracing specification</a></li><li><a href=https://github.com/opentracing/specification/blob/master/rfc/trace_identifiers.md>Opentracing wire protocols</a></li><li><a href=https://istio.io/docs/tasks/telemetry/distributed-tracing/overview/#trace-context-propagation>Istio Trace context propagation</a></li><li><a href=https://medium.com/jaegertracing/using-opentracing-with-istio-envoy-d8a4246bdc15>Using OpenTracing with Istio/Envoy</a></li><li><a href=https://github.com/apache/incubator-zipkin-b3-propagation>Zipkin-b3-propagation</a></li><li><a href=https://www.infoq.cn/article/pqy*PFPhox9OQQ9iCRTt>Istio 调用链埋点原理剖析—是否真的“零修改”？</a></li><li><a href="https://www.youtube.com/watch?v=ySR_FVNX4bQ&amp;t=184s">OpenTracing Project Deep Dive</a></li></ol><div class="entry-shang text-center"><p>「真诚赞赏，手留余香」</p><button class="zs show-zs btn btn-bred">赞赏支持</button></div><div class=zs-modal-bg></div><div class=zs-modal-box><div class=zs-modal-head><button type=button class=close>×</button>
<span class=author><a href=https://lopins.github.io/hugo-template/><img src=/hugo-template/img/favicon.png>Huabing Blog</a></span><p class=tip><i></i><span>真诚赞赏，手留余香</span></p></div><div class=zs-modal-body><div class=zs-modal-btns><button class="btn btn-blink" data-num=2>2元</button>
<button class="btn btn-blink" data-num=5>5元</button>
<button class="btn btn-blink" data-num=10>10元</button>
<button class="btn btn-blink" data-num=50>50元</button>
<button class="btn btn-blink" data-num=100>100元</button>
<button class="btn btn-blink" data-num=1>任意金额</button></div><div class=zs-modal-pay><button class="btn btn-bred" id=pay-text>2元</button><p>使用<span id=pay-type>微信</span>扫描二维码完成支付</p><img src=/hugo-template/img/reward/wechat-2.png id=pay-image></div></div><div class=zs-modal-footer><label><input type=radio name=zs-type value=wechat class=zs-type checked><span><span class=zs-wechat><img src=/hugo-template/img/reward/wechat-btn.png></span></label>
<label><input type=radio name=zs-type value=alipay class=zs-type class=zs-alipay><img src=/hugo-template/img/reward/alipay-btn.png></span></label></div></div><script type=text/javascript src=/hugo-template/js/reward.js></script><hr><ul class=pager><li class=previous><a href=/hugo-template/post/2019-07-02-using-opentracing-with-istio/ data-toggle=tooltip data-placement=top title=洞若观火：使用OpenTracing增强Istio的调用链跟踪>&larr;
Previous Post</a></li><li class=next><a href=/hugo-template/post/2019-07-02-using-opentracing-with-istio-english/ data-toggle=tooltip data-placement=top title="Enhance Istio Distributed Tracing with OpenTracing">Next
Post &rarr;</a></li></ul><link href=https://xxx.xxx.com/dist/Artalk.css rel=stylesheet><script src=https://xxx.xxx.com/dist/Artalk.js></script><div id=Comments></div><script>Artalk.init({el:"#Comments",pageKey:"https://lopins.github.io/hugo-template/post/2019-06-22-using-opentracing-with-istio-english/",pageTitle:"Enhance Istio Distributed Tracing with OpenTracing",server:"https://xxx.xxx.com",site:"xxx blog"})</script></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5><a href=/tags/>FEATURED TAGS</a></h5><div class=tags><a href=/tags/aeraki title=aeraki>aeraki
</a><a href=/tags/aeraki-mesh title="aeraki mesh">aeraki mesh
</a><a href=/tags/ambient-mesh title="ambient mesh">ambient mesh
</a><a href=/tags/api-gateway title="api gateway">api gateway
</a><a href=/tags/bitcoin title=bitcoin>bitcoin
</a><a href=/tags/blockchain title=blockchain>blockchain
</a><a href=/tags/cka title=cka>cka
</a><a href=/tags/cncf title=cncf>cncf
</a><a href=/tags/cryptocurrency title=cryptocurrency>cryptocurrency
</a><a href=/tags/digital-signature title="digital signature">digital signature
</a><a href=/tags/docker title=docker>docker
</a><a href=/tags/dubbo title=dubbo>dubbo
</a><a href=/tags/envoy title=envoy>envoy
</a><a href=/tags/envoy-gateway title="envoy gateway">envoy gateway
</a><a href=/tags/ingress title=ingress>ingress
</a><a href=/tags/istio title=istio>istio
</a><a href=/tags/jaeger title=jaeger>jaeger
</a><a href=/tags/kafka title=kafka>kafka
</a><a href=/tags/knowledge-graph title="knowledge graph">knowledge graph
</a><a href=/tags/kubecon title=kubecon>kubecon
</a><a href=/tags/kubernetes title=kubernetes>kubernetes
</a><a href=/tags/linux title=linux>linux
</a><a href=/tags/loadbalancer title=loadbalancer>loadbalancer
</a><a href=/tags/metaprotocol title=metaprotocol>metaprotocol
</a><a href=/tags/microservice title=microservice>microservice
</a><a href=/tags/network title=network>network
</a><a href=/tags/network-service-mesh title="network service mesh">network service mesh
</a><a href=/tags/nfv title=nfv>nfv
</a><a href=/tags/nodeport title=nodeport>nodeport
</a><a href=/tags/onap title=onap>onap
</a><a href=/tags/opentracing title=opentracing>opentracing
</a><a href=/tags/pilot title=pilot>pilot
</a><a href=/tags/proxy-protocol title="proxy protocol">proxy protocol
</a><a href=/tags/redis title=redis>redis
</a><a href=/tags/sdn title=sdn>sdn
</a><a href=/tags/security title=security>security
</a><a href=/tags/service-mesh title="service mesh">service mesh
</a><a href=/tags/tencent title=tencent>tencent
</a><a href=/tags/x-forwarded-for title=x-forwarded-for>x-forwarded-for</a></div></section><section><hr><h5>FRIENDS</h5><ul class=list-inline><li><a target=_blank href=https://zhaozhihan.com>Linda的博客</a></li></ul></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:youremail@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=/hugo-template/your%20wechat%20qr%20code%20image><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-weixin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/yourgithub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://www.linkedin.com/in/yourlinkedinid><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://stackoverflow.com/users/yourstackoverflowid><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li><li><a href rel=alternate type=application/rss+xml title="Huabing Blog"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; Huabing Blog 2024<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://zhaohuabing.com>Huabing</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe></p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,a=$(_containerSelector),r=a.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),r.each(function(){t=$(this).prop("tagName").toLowerCase(),o="#"+$(this).prop("id"),n=$(this).text(),i=$('<a href="'+o+'" rel="nofollow">'+n+"</a>"),s=$('<li class="'+t+'_nav"></li>').append(i),$(e).append(s)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/hugo-template/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>