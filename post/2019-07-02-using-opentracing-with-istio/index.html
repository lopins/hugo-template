<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="Huabing Blog"><meta property="og:type" content="article"><meta property="og:image" content="https://zhaohuabing.com/static/img/2019-07-02-using-opentracing-with-istio/background.jpg"><meta property="twitter:image" content="https://zhaohuabing.com/static/img/2019-07-02-using-opentracing-with-istio/background.jpg"><meta name=title content="洞若观火：使用OpenTracing增强Istio的调用链跟踪"><meta property="og:title" content="洞若观火：使用OpenTracing增强Istio的调用链跟踪"><meta property="twitter:title" content="洞若观火：使用OpenTracing增强Istio的调用链跟踪"><meta name=description content="本文将接着上一篇继续介绍如何利用OpenTracing来对Kafka异步消息进行跟踪，并将异步消息的跟踪信息加入Istio/Envoy生成的分布式调用跟踪链中进行统一呈现。"><meta property="og:description" content="本文将接着上一篇继续介绍如何利用OpenTracing来对Kafka异步消息进行跟踪，并将异步消息的跟踪信息加入Istio/Envoy生成的分布式调用跟踪链中进行统一呈现。"><meta property="twitter:description" content="本文将接着上一篇继续介绍如何利用OpenTracing来对Kafka异步消息进行跟踪，并将异步消息的跟踪信息加入Istio/Envoy生成的分布式调用跟踪链中进行统一呈现。"><meta property="twitter:card" content="summary"><meta name=keyword content="赵化冰, zhaohuabing, Zhaohuabing, , 赵化冰的网络日志, 赵化冰的博客, Zhaohuabing Blog, 博客, 个人网站, 互联网, Web, 云原生, PaaS, Istio, Kubernetes, 微服务, Microservice"><link rel="shortcut icon" href=/hugo-template/img/favicon.ico><title>洞若观火：使用OpenTracing增强Istio的调用链跟踪 | 赵化冰的博客 | Zhaohuabing Blog</title>
<link rel=canonical href=/hugo-template/post/2019-07-02-using-opentracing-with-istio/><link rel=stylesheet href=/hugo-template/css/bootstrap.min.css><link rel=stylesheet href=/hugo-template/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/hugo-template/css/zanshang.css><link rel=stylesheet href=/hugo-template/css/font-awesome.all.min.css><script src=/hugo-template/js/jquery.min.js></script><script src=/hugo-template/js/bootstrap.min.js></script><script src=/hugo-template/js/hux-blog.min.js></script><script src=/hugo-template/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=/>Huabing Blog</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/hugo-template/categories/books/>books</a></li><li><a href=/hugo-template/categories/open-source/>open source</a></li><li><a href=/hugo-template/categories/presentations/>presentations</a></li><li><a href=/hugo-template/categories/tech/>tech</a></li><li><a href=/archive//>ARCHIVE</a></li><li><a href=/notes//>NOTES</a></li><li><a href=/about//>ABOUT</a></li><li><a href=/hugo-template/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(https://zhaohuabing.com/static/img/2019-07-02-using-opentracing-with-istio/background.jpg)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/service-mesh title="Service Mesh">Service Mesh
</a><a class=tag href=/tags/istio title=Istio>Istio
</a><a class=tag href=/tags/opentracing title=Opentracing>Opentracing
</a><a class=tag href=/tags/jaeger title=Jaeger>Jaeger
</a><a class=tag href=/tags/kafka title=Kafka>Kafka</a></div><h1>洞若观火：使用OpenTracing增强Istio的调用链跟踪</h1><h2 class=subheading>第二篇：如何利用Opentracing实现Kafka消息的调用跟踪</h2><span class=meta>Posted by
    "赵化冰"
on
Tuesday, July 2, 2019</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p>在上一篇文章中，我们通过一个网上商店的示例程序学习了如何使用Opentracing在Istio服务网格中传递分布式调用跟踪的上下文，以及如何将方法级的调用信息加入到Istio/Envoy生成的调用链中。采用Opentracing可以减少应用代码中传递HTTP header的重复代码；也可以根据需要在调用链中加入更细粒度的Span，以用于对系统性能瓶颈进行在线分析。</p><p>在实际项目中，除了同步调用之外，异步消息也是微服务架构中常见的一种通信方式。在本篇文章中，我将继续利用eshop demo程序来探讨如何通过Opentracing将Kafka异步消息也纳入到Istio的分布式调用跟踪中。</p><h1 id=eshop-示例程序结构>eshop 示例程序结构</h1><p>如下图所示，demo程序中增加了发送和接收Kafka消息的代码。eshop微服务在调用inventory，billing，delivery服务后，发送了一个kafka消息通知，consumer接收到通知后调用notification服务的REST接口向用户发送购买成功的邮件通知。</p><p><img src=https://zhaohuabing.com/static/img/2019-07-02-using-opentracing-with-istio/eshop-demo.jpg alt></p><h1 id=将kafka消息处理加入调用链跟踪>将Kafka消息处理加入调用链跟踪</h1><h2 id=植入kafka-opentracing代码>植入Kafka Opentracing代码</h2><p>首先从github下载代码。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone git@github.com:zhaohuabing/istio-opentracing-demo.git
</span></span><span style=display:flex><span>git checkout kafka-tracking
</span></span></code></pre></div><p>可以直接使用 kafka-tracking 这个分支的代码，但建议跟随下面的步骤查看相关的代码，以了解各个步骤背后的原理。</p><p>根目录下分为了rest-service和kafka-consumer两个目录，rest-service下包含了各个REST服务的代码，kafka-consumer下是Kafka消息消费者的代码。</p><p>首先需要将spring kafka和Opentracing kafka的依赖加入到两个目录下的pom文件中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#ff79c6>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>&lt;groupId&gt;</span>org.springframework.kafka<span style=color:#ff79c6>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>&lt;artifactId&gt;</span>spring-kafka<span style=color:#ff79c6>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span> <span style=color:#ff79c6>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>&lt;groupId&gt;</span>io.opentracing.contrib<span style=color:#ff79c6>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>&lt;artifactId&gt;</span>opentracing-kafka-client<span style=color:#ff79c6>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>&lt;version&gt;</span>${version.opentracing.kafka-client}<span style=color:#ff79c6>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>在rest-service目录中的KafkaConfig.java中配置消息Producer端的Opentracing Instrument。TracingProducerInterceptor会在发送Kafka消息时生成发送端的Span。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Bean
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> ProducerFactory<span style=color:#ff79c6>&lt;</span>String, String<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>producerFactory</span>() {
</span></span><span style=display:flex><span>    Map<span style=color:#ff79c6>&lt;</span>String, Object<span style=color:#ff79c6>&gt;</span> configProps <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    configProps.<span style=color:#50fa7b>put</span>(ProducerConfig.<span style=color:#50fa7b>BOOTSTRAP_SERVERS_CONFIG</span>, bootstrapAddress);
</span></span><span style=display:flex><span>    configProps.<span style=color:#50fa7b>put</span>(ProducerConfig.<span style=color:#50fa7b>KEY_SERIALIZER_CLASS_CONFIG</span>, StringSerializer.<span style=color:#50fa7b>class</span>);
</span></span><span style=display:flex><span>    configProps.<span style=color:#50fa7b>put</span>(ProducerConfig.<span style=color:#50fa7b>VALUE_SERIALIZER_CLASS_CONFIG</span>, StringSerializer.<span style=color:#50fa7b>class</span>);
</span></span><span style=display:flex><span>    configProps.<span style=color:#50fa7b>put</span>(ProducerConfig.<span style=color:#50fa7b>INTERCEPTOR_CLASSES_CONFIG</span>, TracingProducerInterceptor.<span style=color:#50fa7b>class</span>.<span style=color:#50fa7b>getName</span>());
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> DefaultKafkaProducerFactory<span style=color:#ff79c6>&lt;&gt;</span>(configProps);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在kafka-consumer目录中的KafkaConfig.java中配置消息Consumer端的Opentracing Instrument。TracingConsumerInterceptor会在接收到Kafka消息是生成接收端的Span。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Bean
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> ConsumerFactory<span style=color:#ff79c6>&lt;</span>String, String<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>consumerFactory</span>() {
</span></span><span style=display:flex><span>    Map<span style=color:#ff79c6>&lt;</span>String, Object<span style=color:#ff79c6>&gt;</span> props <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    props.<span style=color:#50fa7b>put</span>(ConsumerConfig.<span style=color:#50fa7b>BOOTSTRAP_SERVERS_CONFIG</span>, bootstrapAddress);
</span></span><span style=display:flex><span>    props.<span style=color:#50fa7b>put</span>(ConsumerConfig.<span style=color:#50fa7b>GROUP_ID_CONFIG</span>, groupId);
</span></span><span style=display:flex><span>    props.<span style=color:#50fa7b>put</span>(ConsumerConfig.<span style=color:#50fa7b>KEY_DESERIALIZER_CLASS_CONFIG</span>, StringDeserializer.<span style=color:#50fa7b>class</span>);
</span></span><span style=display:flex><span>    props.<span style=color:#50fa7b>put</span>(ConsumerConfig.<span style=color:#50fa7b>VALUE_DESERIALIZER_CLASS_CONFIG</span>, StringDeserializer.<span style=color:#50fa7b>class</span>);
</span></span><span style=display:flex><span>    props.<span style=color:#50fa7b>put</span>(ConsumerConfig.<span style=color:#50fa7b>INTERCEPTOR_CLASSES_CONFIG</span>, TracingConsumerInterceptor.<span style=color:#50fa7b>class</span>.<span style=color:#50fa7b>getName</span>());
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> DefaultKafkaConsumerFactory<span style=color:#ff79c6>&lt;&gt;</span>(props);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>只需要这两步即可完成Spring程序的Kafka Opentracing代码植入。下面安装并运行示例程序查看效果。</p><h2 id=安装kafka集群>安装Kafka集群</h2><p>示例程序中使用到了Kafka消息，因此需要部署一个Kafka集群。可以参照 <a href=https://kafka.apache.org/quickstart>Kafka Quickstart</a> 在Kubernetes集群外部署Kafka；也可以使用 <a href=https://github.com/strimzi/strimzi-kafka-operator>Kafka Operator</a> 直接将Kafka部署在Kubernetes集群中。</p><h2 id=部署demo应用>部署demo应用</h2><p>修改Kubernetes yaml部署文件 k8s/eshop.yaml，设置Kafka bootstrap server，以用于demo程序连接到Kafka集群中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: extensions/v1beta1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Deployment
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: eshop-v1
</span></span><span style=display:flex><span>  ......
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ff79c6>name</span>: eshop
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>image</span>: zhaohuabing/istio-opentracing-demo:kafka-opentracing
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>containerPort</span>: <span style=color:#bd93f9>8080</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>env</span>:
</span></span><span style=display:flex><span>          ....
</span></span><span style=display:flex><span>          //在这里加入Kafka server地址
</span></span><span style=display:flex><span>          - <span style=color:#ff79c6>name</span>: KAFKA_BOOTSTRAP_SERVERS
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>value</span>: <span style=color:#f1fa8c>&#34;192.168.89.192:9092&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: extensions/v1beta1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Deployment
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: kafka-consumer-v1
</span></span><span style=display:flex><span>  ......
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ff79c6>name</span>: kafka-consumer
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>image</span>: zhaohuabing/istio-opentracing-demo-kafka-consumer:kafka-opentracing
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>env</span>:
</span></span><span style=display:flex><span>          ....
</span></span><span style=display:flex><span>          //在这里加入Kafka server地址
</span></span><span style=display:flex><span>          - <span style=color:#ff79c6>name</span>: KAFKA_BOOTSTRAP_SERVERS
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>value</span>: <span style=color:#f1fa8c>&#34;192.168.89.192:9092&#34;</span>
</span></span></code></pre></div><p>然后部署应用程序，相关的镜像可以直接从dockerhub下载，也可以通过源码编译生成。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f k8s/eshop.yaml
</span></span></code></pre></div><p>在浏览器中打开地址：http://${NODE_IP}:31380/checkout ，以触发调用eshop示例程序的REST接口。然后打开Jaeger的界面 http://${NODE_IP}:30088 查看生成的分布式调用跟踪信息。
<img src=https://zhaohuabing.com/static/img/2019-07-02-using-opentracing-with-istio/istio-tracing-opentracing-kafka.jpg alt></p><p>从图中可以看到，在调用链中增加了两个Span，分布对应于Kafka消息发送和接收的两个操作。由于Kafka消息的处理是异步的，消息发送端不直接依赖接收端的处理。根据Opentracing对引用关系的定义，From_eshop_topic Span 对 To_eshop_topic Span 的引用关系是 FOLLOWS_FROM 而不是 CHILD_OF 关系。</p><h1 id=将调用跟踪上下文从kafka传递到rest服务>将调用跟踪上下文从Kafka传递到REST服务</h1><p>现在eshop代码中已经加入了REST和Kafka的Opentracing Instrumentation，可以在进行REST调用和发送Kafka消息时生成调用跟踪信息。但如果需要从Kafka的消息消费者的处理方法中调用一个REST接口呢？</p><p>我们会发现在eshop示例程序中，缺省生成的调用链里面并不会把Kafka消费者的Span和其发起的调用notification服务的REST请求的Span关联在同一个Trace中。</p><p>要分析导致该问题的原因，我们首先需要了解<a href=https://opentracing.io/docs/overview/scopes-and-threading/>“Active Span”</a>的概念。在Opentracing中，一个线程可以有一个Active Span，该Active Span代表了目前该线程正在执行的工作。在调用Tracer.buildSpan()方法创建新的Span时，如果Tracer目前存在一个Active Span，则会将该Active Span缺省作为新创建的Span的Parent Span。</p><p>Tracer.buildSpan 方法的说明如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>Tracer.<span style=color:#50fa7b>SpanBuilder</span> <span style=color:#50fa7b>buildSpan</span>(String operationName)
</span></span><span style=display:flex><span>Return a <span style=color:#ff79c6>new</span> SpanBuilder <span style=color:#ff79c6>for</span> a Span with the given `operationName`.
</span></span><span style=display:flex><span>You can override the operationName later via BaseSpan.<span style=color:#50fa7b>setOperationName</span>(String).
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>A contrived example:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   Tracer tracer <span style=color:#ff79c6>=</span> ...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// Note: if there is a `tracer.activeSpan()`, it will be used as the target of an implicit CHILD_OF</span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// Reference for &#34;workSpan&#34; when `startActive()` is invoked.</span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// 如果存在active span，则其创建的新Span会隐式地创建一个 CHILD_OF 引用到该active span</span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>try</span> (ActiveSpan workSpan <span style=color:#ff79c6>=</span> tracer.<span style=color:#50fa7b>buildSpan</span>(<span style=color:#f1fa8c>&#34;DoWork&#34;</span>).<span style=color:#50fa7b>startActive</span>()) {
</span></span><span style=display:flex><span>       workSpan.<span style=color:#50fa7b>setTag</span>(<span style=color:#f1fa8c>&#34;...&#34;</span>, <span style=color:#f1fa8c>&#34;...&#34;</span>);
</span></span><span style=display:flex><span>       <span style=color:#6272a4>// etc, etc</span>
</span></span><span style=display:flex><span>   }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// 也可以通过asChildOf方法指定新创建的Span的Parent Span</span>
</span></span><span style=display:flex><span>   <span style=color:#6272a4>// It&#39;s also possible to create Spans manually, bypassing the ActiveSpanSource activation.</span>
</span></span><span style=display:flex><span>   Span http <span style=color:#ff79c6>=</span> tracer.<span style=color:#50fa7b>buildSpan</span>(<span style=color:#f1fa8c>&#34;HandleHTTPRequest&#34;</span>)
</span></span><span style=display:flex><span>                     .<span style=color:#50fa7b>asChildOf</span>(rpcSpanContext)  <span style=color:#6272a4>// an explicit parent</span>
</span></span><span style=display:flex><span>                     .<span style=color:#50fa7b>withTag</span>(<span style=color:#f1fa8c>&#34;user_agent&#34;</span>, req.<span style=color:#50fa7b>UserAgent</span>)
</span></span><span style=display:flex><span>                     .<span style=color:#50fa7b>withTag</span>(<span style=color:#f1fa8c>&#34;lucky_number&#34;</span>, 42)
</span></span><span style=display:flex><span>                     .<span style=color:#50fa7b>startManual</span>();
</span></span></code></pre></div><p>分析Kafka Opentracing Instrumentation的代码，会发现TracingConsumerInterceptor在调用Kafka消费者的处理方法之前已经把消费者的Span结束了，因此发起REST调用时tracer没有active span，不会将Kafka消费者的Span作为后面REST调用的parent span。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#ff79c6>&lt;</span>K, V<span style=color:#ff79c6>&gt;</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>buildAndFinishChildSpan</span>(ConsumerRecord<span style=color:#ff79c6>&lt;</span>K, V<span style=color:#ff79c6>&gt;</span> record, Tracer tracer,
</span></span><span style=display:flex><span>      BiFunction<span style=color:#ff79c6>&lt;</span>String, ConsumerRecord, String<span style=color:#ff79c6>&gt;</span> consumerSpanNameProvider) {
</span></span><span style=display:flex><span>    SpanContext parentContext <span style=color:#ff79c6>=</span> TracingKafkaUtils.<span style=color:#50fa7b>extractSpanContext</span>(record.<span style=color:#50fa7b>headers</span>(), tracer);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    String consumerOper <span style=color:#ff79c6>=</span>
</span></span><span style=display:flex><span>        FROM_PREFIX <span style=color:#ff79c6>+</span> record.<span style=color:#50fa7b>topic</span>(); <span style=color:#6272a4>// &lt;====== It provides better readability in the UI</span>
</span></span><span style=display:flex><span>    Tracer.<span style=color:#50fa7b>SpanBuilder</span> spanBuilder <span style=color:#ff79c6>=</span> tracer
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>buildSpan</span>(consumerSpanNameProvider.<span style=color:#50fa7b>apply</span>(consumerOper, record))
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>withTag</span>(Tags.<span style=color:#50fa7b>SPAN_KIND</span>.<span style=color:#50fa7b>getKey</span>(), Tags.<span style=color:#50fa7b>SPAN_KIND_CONSUMER</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (parentContext <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>      spanBuilder.<span style=color:#50fa7b>addReference</span>(References.<span style=color:#50fa7b>FOLLOWS_FROM</span>, parentContext);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Span span <span style=color:#ff79c6>=</span> spanBuilder.<span style=color:#50fa7b>start</span>();
</span></span><span style=display:flex><span>    SpanDecorator.<span style=color:#50fa7b>onResponse</span>(record, span);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>//在调用消费者的处理方法之前，该Span已经被结束。</span>
</span></span><span style=display:flex><span>    span.<span style=color:#50fa7b>finish</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// Inject created span context into record headers for extraction by client to continue span chain</span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>//这个Span被放到了Kafka消息的header中</span>
</span></span><span style=display:flex><span>    TracingKafkaUtils.<span style=color:#50fa7b>inject</span>(span.<span style=color:#50fa7b>context</span>(), record.<span style=color:#50fa7b>headers</span>(), tracer);
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>此时TracingConsumerInterceptor已经将Kafka消费者的Span放到了Kafka消息的header中，因此从Kafka消息头中取出该Span，显示地将Kafka消费者的Span作为REST调用的Parent Span即可。</p><p>为MessageConsumer.java使用的RestTemplate设置一个TracingKafka2RestTemplateInterceptor。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@KafkaListener(topics <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;eshop-topic&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>receiveMessage</span>(ConsumerRecord<span style=color:#ff79c6>&lt;</span>String, String<span style=color:#ff79c6>&gt;</span> record) {
</span></span><span style=display:flex><span>    restTemplate
</span></span><span style=display:flex><span>            .<span style=color:#50fa7b>setInterceptors</span>(Collections.<span style=color:#50fa7b>singletonList</span>(<span style=color:#ff79c6>new</span> TracingKafka2RestTemplateInterceptor(record.<span style=color:#50fa7b>headers</span>())));
</span></span><span style=display:flex><span>    restTemplate.<span style=color:#50fa7b>getForEntity</span>(<span style=color:#f1fa8c>&#34;http://notification:8080/sendEmail&#34;</span>, String.<span style=color:#50fa7b>class</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>TracingKafka2RestTemplateInterceptor是基于Spring Opentracing Instrumentation的TracingRestTemplateInterceptor修改的，将从Kafka header中取出的Span设置为出向请求的Span的Parent Span。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Override
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> ClientHttpResponse <span style=color:#50fa7b>intercept</span>(HttpRequest httpRequest, <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> body, ClientHttpRequestExecution xecution)
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>throws</span> IOException {
</span></span><span style=display:flex><span>    ClientHttpResponse httpResponse;
</span></span><span style=display:flex><span>    SpanContext parentSpanContext <span style=color:#ff79c6>=</span> TracingKafkaUtils.<span style=color:#50fa7b>extractSpanContext</span>(headers, tracer);
</span></span><span style=display:flex><span>    Span span <span style=color:#ff79c6>=</span> tracer.<span style=color:#50fa7b>buildSpan</span>(httpRequest.<span style=color:#50fa7b>getMethod</span>().<span style=color:#50fa7b>toString</span>()).<span style=color:#50fa7b>asChildOf</span>(parentSpanContext)
</span></span><span style=display:flex><span>            .<span style=color:#50fa7b>withTag</span>(Tags.<span style=color:#50fa7b>SPAN_KIND</span>.<span style=color:#50fa7b>getKey</span>(), Tags.<span style=color:#50fa7b>SPAN_KIND_CLIENT</span>).<span style=color:#50fa7b>start</span>();
</span></span><span style=display:flex><span>    ......
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在浏览器中打开地址：http://${NODE_IP}:31380/checkout ，以触发调用eshop示例程序的REST接口。然后打开Jaeger的界面 http://${NODE_IP}:30088 查看生成的分布式调用跟踪信息。
<img src=https://zhaohuabing.com/static/img/2019-07-02-using-opentracing-with-istio/istio-tracing-opentracing-kafka-rest.jpg alt></p><p>从上图可以看到，调用链中出现了Kafka消费者调用notification服务的sendEmail REST接口的Span。从图中可以看到，由于调用链经过了Kafka消息，sendEmail Span的时间没有包含在checkout Span中。</p><p>在Jaeger UI上将图形切换为trace graph，可以更清晰地表示出各个Span之间的调用关系。
<img src=https://zhaohuabing.com/static/img/2019-07-02-using-opentracing-with-istio/trace-graph.jpg alt></p><h1 id=总结>总结</h1><p>Istio服务网格通过分布式调用跟踪来提高微服务应用的可见性。我们可以使用Opentracing Instrumentation来代替应用编码传递分布式跟踪的相关http header；还可以将方法级的调用跟踪和Kafka消息的调用跟踪加入到Istio生成的调用跟踪链中，以提供更细粒度的调用跟踪信息。</p><p>该方案可以达到分布式调用跟踪的目的，但需要在代码框架层进行一定的改动，以植入调用跟踪的相关代码。理想的方案是由服务网格基础设施层来完成所有调用跟踪的数据收集和生成，这样应用代码只需关注业务逻辑，而不用处理调用跟踪信息的生成。可以在Envoy中加入插件来为Kafka消息生成调用跟踪信息，但目前看来服务网格还没有很好的办法在上下游服务之前传递调用跟踪上下文。</p><h1 id=参考资料>参考资料</h1><ol><li><a href=https://github.com/zhaohuabing/istio-opentracing-demo/tree/kafka-tracking>本文中eshop示例程序的源代码</a></li><li><a href=https://objectpartners.com/2019/04/25/distributed-tracing-with-apache-kafka-and-jaeger/>Distributed Tracing with Apache Kafka and Jaeger</a></li><li>[OpenTracing Apache Kafka Client Instrumentation](<a href=https://github.com/opentracing-contrib/java-kafka-client>https://github.com/opentracing-contrib/java-kafka-client</a>
TracingRestTemplateInterceptor.java)</li><li><a href=https://kafka.apache.org/quickstart>Kafka quick start</a></li><li>参考代码：<ul><li><a href=https://github.com/opentracing-contrib/java-spring-web/blob/master/opentracing-spring-web/src/main/java/io/opentracing/contrib/spring/web/client/TracingRestTemplateInterceptor.java>https://github.com/opentracing-contrib/java-spring-web/blob/master/opentracing-spring-web/src/main/java/io/opentracing/contrib/spring/web/client/TracingRestTemplateInterceptor.java</a></li><li><a href=https://github.com/burkaa01/jaeger-tracing-kafka/blob/master/spring-consumer-app/src/main/java/com/github/burkaa01/springconsumer/config/TracingChildRestTemplateInterceptor.java>https://github.com/burkaa01/jaeger-tracing-kafka/blob/master/spring-consumer-app/src/main/java/com/github/burkaa01/springconsumer/config/TracingChildRestTemplateInterceptor.java</a></li><li><a href=https://github.com/opentracing-contrib/java-kafka-client/blob/master/opentracing-kafka-client/src/main/java/io/opentracing/contrib/kafka/TracingConsumerInterceptor.java>https://github.com/opentracing-contrib/java-kafka-client/blob/master/opentracing-kafka-client/src/main/java/io/opentracing/contrib/kafka/TracingConsumerInterceptor.java</a></li><li><a href=https://github.com/opentracing-contrib/java-kafka-client/blob/master/opentracing-kafka-client/src/main/java/io/opentracing/contrib/kafka/TracingKafkaUtils.java>https://github.com/opentracing-contrib/java-kafka-client/blob/master/opentracing-kafka-client/src/main/java/io/opentracing/contrib/kafka/TracingKafkaUtils.java</a></li></ul></li></ol><div class="entry-shang text-center"><p>「真诚赞赏，手留余香」</p><button class="zs show-zs btn btn-bred">赞赏支持</button></div><div class=zs-modal-bg></div><div class=zs-modal-box><div class=zs-modal-head><button type=button class=close>×</button>
<span class=author><a href=https://lopins.github.io/hugo-template/><img src=/hugo-template/img/favicon.png>Huabing Blog</a></span><p class=tip><i></i><span>真诚赞赏，手留余香</span></p></div><div class=zs-modal-body><div class=zs-modal-btns><button class="btn btn-blink" data-num=2>2元</button>
<button class="btn btn-blink" data-num=5>5元</button>
<button class="btn btn-blink" data-num=10>10元</button>
<button class="btn btn-blink" data-num=50>50元</button>
<button class="btn btn-blink" data-num=100>100元</button>
<button class="btn btn-blink" data-num=1>任意金额</button></div><div class=zs-modal-pay><button class="btn btn-bred" id=pay-text>2元</button><p>使用<span id=pay-type>微信</span>扫描二维码完成支付</p><img src=/hugo-template/img/reward/wechat-2.png id=pay-image></div></div><div class=zs-modal-footer><label><input type=radio name=zs-type value=wechat class=zs-type checked><span><span class=zs-wechat><img src=/hugo-template/img/reward/wechat-btn.png></span></label>
<label><input type=radio name=zs-type value=alipay class=zs-type class=zs-alipay><img src=/hugo-template/img/reward/alipay-btn.png></span></label></div></div><script type=text/javascript src=/hugo-template/js/reward.js></script><hr><ul class=pager><li class=previous><a href=/hugo-template/post/2019-06-25-kubecon-cncf-oss-2019/ data-toggle=tooltip data-placement=top title=开源，社区与朋友们>&larr;
Previous Post</a></li><li class=next><a href=/hugo-template/post/2019-06-22-using-opentracing-with-istio-english/ data-toggle=tooltip data-placement=top title="Enhance Istio Distributed Tracing with OpenTracing">Next
Post &rarr;</a></li></ul><link href=https://xxx.xxx.com/dist/Artalk.css rel=stylesheet><script src=https://xxx.xxx.com/dist/Artalk.js></script><div id=Comments></div><script>Artalk.init({el:"#Comments",pageKey:"https://lopins.github.io/hugo-template/post/2019-07-02-using-opentracing-with-istio/",pageTitle:"洞若观火：使用OpenTracing增强Istio的调用链跟踪",server:"https://xxx.xxx.com",site:"xxx blog"})</script></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5><a href=/tags/>FEATURED TAGS</a></h5><div class=tags><a href=/tags/aeraki title=aeraki>aeraki
</a><a href=/tags/aeraki-mesh title="aeraki mesh">aeraki mesh
</a><a href=/tags/ambient-mesh title="ambient mesh">ambient mesh
</a><a href=/tags/api-gateway title="api gateway">api gateway
</a><a href=/tags/bitcoin title=bitcoin>bitcoin
</a><a href=/tags/blockchain title=blockchain>blockchain
</a><a href=/tags/cka title=cka>cka
</a><a href=/tags/cncf title=cncf>cncf
</a><a href=/tags/cryptocurrency title=cryptocurrency>cryptocurrency
</a><a href=/tags/digital-signature title="digital signature">digital signature
</a><a href=/tags/docker title=docker>docker
</a><a href=/tags/dubbo title=dubbo>dubbo
</a><a href=/tags/envoy title=envoy>envoy
</a><a href=/tags/envoy-gateway title="envoy gateway">envoy gateway
</a><a href=/tags/ingress title=ingress>ingress
</a><a href=/tags/istio title=istio>istio
</a><a href=/tags/jaeger title=jaeger>jaeger
</a><a href=/tags/kafka title=kafka>kafka
</a><a href=/tags/knowledge-graph title="knowledge graph">knowledge graph
</a><a href=/tags/kubecon title=kubecon>kubecon
</a><a href=/tags/kubernetes title=kubernetes>kubernetes
</a><a href=/tags/linux title=linux>linux
</a><a href=/tags/loadbalancer title=loadbalancer>loadbalancer
</a><a href=/tags/metaprotocol title=metaprotocol>metaprotocol
</a><a href=/tags/microservice title=microservice>microservice
</a><a href=/tags/network title=network>network
</a><a href=/tags/network-service-mesh title="network service mesh">network service mesh
</a><a href=/tags/nfv title=nfv>nfv
</a><a href=/tags/nodeport title=nodeport>nodeport
</a><a href=/tags/onap title=onap>onap
</a><a href=/tags/opentracing title=opentracing>opentracing
</a><a href=/tags/pilot title=pilot>pilot
</a><a href=/tags/proxy-protocol title="proxy protocol">proxy protocol
</a><a href=/tags/redis title=redis>redis
</a><a href=/tags/sdn title=sdn>sdn
</a><a href=/tags/security title=security>security
</a><a href=/tags/service-mesh title="service mesh">service mesh
</a><a href=/tags/tencent title=tencent>tencent
</a><a href=/tags/x-forwarded-for title=x-forwarded-for>x-forwarded-for</a></div></section><section><hr><h5>FRIENDS</h5><ul class=list-inline><li><a target=_blank href=https://zhaozhihan.com>Linda的博客</a></li></ul></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:youremail@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=/hugo-template/your%20wechat%20qr%20code%20image><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-weixin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/yourgithub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://www.linkedin.com/in/yourlinkedinid><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://stackoverflow.com/users/yourstackoverflowid><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li><li><a href rel=alternate type=application/rss+xml title="Huabing Blog"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; Huabing Blog 2024<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://zhaohuabing.com>Huabing</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe></p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,a=$(_containerSelector),r=a.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),r.each(function(){t=$(this).prop("tagName").toLowerCase(),o="#"+$(this).prop("id"),n=$(this).text(),i=$('<a href="'+o+'" rel="nofollow">'+n+"</a>"),s=$('<li class="'+t+'_nav"></li>').append(i),$(e).append(s)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/hugo-template/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>