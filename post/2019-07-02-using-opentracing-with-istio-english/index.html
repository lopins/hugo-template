<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="Huabing Blog"><meta property="og:type" content="article"><meta property="og:image" content="https://zhaohuabing.com/static/img/2019-07-02-using-opentracing-with-istio/background-english.jpg"><meta property="twitter:image" content="https://zhaohuabing.com/static/img/2019-07-02-using-opentracing-with-istio/background-english.jpg"><meta name=title content="Enhance Istio Distributed Tracing with OpenTracing"><meta property="og:title" content="Enhance Istio Distributed Tracing with OpenTracing"><meta property="twitter:title" content="Enhance Istio Distributed Tracing with OpenTracing"><meta name=description content="In this post, we will continue to use the eshop demo to explore how asynchronous messaging, specifically Kafka, can be traced in Istio service mesh with the help of Opentracing."><meta property="og:description" content="In this post, we will continue to use the eshop demo to explore how asynchronous messaging, specifically Kafka, can be traced in Istio service mesh with the help of Opentracing."><meta property="twitter:description" content="In this post, we will continue to use the eshop demo to explore how asynchronous messaging, specifically Kafka, can be traced in Istio service mesh with the help of Opentracing."><meta property="twitter:card" content="summary"><meta name=keyword content="赵化冰, zhaohuabing, Zhaohuabing, , 赵化冰的网络日志, 赵化冰的博客, Zhaohuabing Blog, 博客, 个人网站, 互联网, Web, 云原生, PaaS, Istio, Kubernetes, 微服务, Microservice"><link rel="shortcut icon" href=/hugo-template/img/favicon.ico><title>Enhance Istio Distributed Tracing with OpenTracing | 赵化冰的博客 | Zhaohuabing Blog</title>
<link rel=canonical href=/hugo-template/post/2019-07-02-using-opentracing-with-istio-english/><link rel=stylesheet href=/hugo-template/css/bootstrap.min.css><link rel=stylesheet href=/hugo-template/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/hugo-template/css/zanshang.css><link rel=stylesheet href=/hugo-template/css/font-awesome.all.min.css><script src=/hugo-template/js/jquery.min.js></script><script src=/hugo-template/js/bootstrap.min.js></script><script src=/hugo-template/js/hux-blog.min.js></script><script src=/hugo-template/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=/>Huabing Blog</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/hugo-template/categories/books/>books</a></li><li><a href=/hugo-template/categories/open-source/>open source</a></li><li><a href=/hugo-template/categories/presentations/>presentations</a></li><li><a href=/hugo-template/categories/tech/>tech</a></li><li><a href=/archive//>ARCHIVE</a></li><li><a href=/notes//>NOTES</a></li><li><a href=/about//>ABOUT</a></li><li><a href=/hugo-template/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(https://zhaohuabing.com/static/img/2019-07-02-using-opentracing-with-istio/background-english.jpg)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/service-mesh title="Service Mesh">Service Mesh
</a><a class=tag href=/tags/istio title=Istio>Istio
</a><a class=tag href=/tags/opentracing title=Opentracing>Opentracing
</a><a class=tag href=/tags/jaeger title=Jaeger>Jaeger
</a><a class=tag href=/tags/kafka title=Kafka>Kafka</a></div><h1>Enhance Istio Distributed Tracing with OpenTracing</h1><h2 class=subheading>Part 2: Enable Async Messaging Tracing with OpenTracing</h2><span class=meta>Posted by
    "赵化冰"
on
Wednesday, September 11, 2019</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p>In the previous post, we discussed how to use Opentracing to help Istio Service Mesh to propagate tracing context across process boundaries, and how to enrich Istio/Envoy generated traces with method-level spans to get more fine-grained insights to the services.</p><p>For now, all that we have been talking is just about synchronous RPC (HTTP/REST), however, we can’t ignore the fact that asynchronous messaging is also widely adopted as an inter-services communication mechanism. So in this post, we will continue to use the eshop demo to explore how asynchronous messaging, specifically Kafka, can be traced in Istio service mesh with the help of Opentracing.</p><h1 id=eshop-demo-application>Eshop Demo Application</h1><p>As depicted in the below diagram, the demo application has been modified to add asynchronous messages related logic. After calling the inventory, billing, and delivery services, the eshop service sends a message to a Kafka topic. The consumer service is listening on this Kafka topic. Once receiving the message, it calls the notification service to send out an email to notify the user that the transaction is successfully done.</p><p><img src=https://zhaohuabing.com/static/img/2019-07-02-using-opentracing-with-istio/eshop-demo.jpg alt></p><h1 id=kafka-opentracing-instrumentation>Kafka Opentracing Instrumentation</h1><p>The source code can be downloaded from Github.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone git@github.com:zhaohuabing/istio-opentracing-demo.git
</span></span><span style=display:flex><span>git checkout kafka-tracking
</span></span></code></pre></div><p>There’re two directories in the project root of the source code: rest-service and kafka-consumer. The code of restful services is put under the rest-service directory, while the kafka consumer code is in the kafka-consumer directory.</p><p>First, the dependencies for spring-kafka and opentracing-kafka should be included in the project pom file.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#ff79c6>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>&lt;groupId&gt;</span>org.springframework.kafka<span style=color:#ff79c6>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>&lt;artifactId&gt;</span>spring-kafka<span style=color:#ff79c6>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;/dependency&gt;</span>
</span></span><span style=display:flex><span> <span style=color:#ff79c6>&lt;dependency&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>&lt;groupId&gt;</span>io.opentracing.contrib<span style=color:#ff79c6>&lt;/groupId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>&lt;artifactId&gt;</span>opentracing-kafka-client<span style=color:#ff79c6>&lt;/artifactId&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>&lt;version&gt;</span>${version.opentracing.kafka-client}<span style=color:#ff79c6>&lt;/version&gt;</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>The next step is configuring the Kafka producer factory to enable Opentracing instrumentation at the producer side.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Bean
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> ProducerFactory<span style=color:#ff79c6>&lt;</span>String, String<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>producerFactory</span>() {
</span></span><span style=display:flex><span>    Map<span style=color:#ff79c6>&lt;</span>String, Object<span style=color:#ff79c6>&gt;</span> configProps <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    configProps.<span style=color:#50fa7b>put</span>(ProducerConfig.<span style=color:#50fa7b>BOOTSTRAP_SERVERS_CONFIG</span>, bootstrapAddress);
</span></span><span style=display:flex><span>    configProps.<span style=color:#50fa7b>put</span>(ProducerConfig.<span style=color:#50fa7b>KEY_SERIALIZER_CLASS_CONFIG</span>, StringSerializer.<span style=color:#50fa7b>class</span>);
</span></span><span style=display:flex><span>    configProps.<span style=color:#50fa7b>put</span>(ProducerConfig.<span style=color:#50fa7b>VALUE_SERIALIZER_CLASS_CONFIG</span>, StringSerializer.<span style=color:#50fa7b>class</span>);
</span></span><span style=display:flex><span>    configProps.<span style=color:#50fa7b>put</span>(ProducerConfig.<span style=color:#50fa7b>INTERCEPTOR_CLASSES_CONFIG</span>, TracingProducerInterceptor.<span style=color:#50fa7b>class</span>.<span style=color:#50fa7b>getName</span>());
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> DefaultKafkaProducerFactory<span style=color:#ff79c6>&lt;&gt;</span>(configProps);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>You’ll also need to configure instrumentation at the consumer side in a similar way.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Bean
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> ConsumerFactory<span style=color:#ff79c6>&lt;</span>String, String<span style=color:#ff79c6>&gt;</span> <span style=color:#50fa7b>consumerFactory</span>() {
</span></span><span style=display:flex><span>    Map<span style=color:#ff79c6>&lt;</span>String, Object<span style=color:#ff79c6>&gt;</span> props <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> HashMap<span style=color:#ff79c6>&lt;&gt;</span>();
</span></span><span style=display:flex><span>    props.<span style=color:#50fa7b>put</span>(ConsumerConfig.<span style=color:#50fa7b>BOOTSTRAP_SERVERS_CONFIG</span>, bootstrapAddress);
</span></span><span style=display:flex><span>    props.<span style=color:#50fa7b>put</span>(ConsumerConfig.<span style=color:#50fa7b>GROUP_ID_CONFIG</span>, groupId);
</span></span><span style=display:flex><span>    props.<span style=color:#50fa7b>put</span>(ConsumerConfig.<span style=color:#50fa7b>KEY_DESERIALIZER_CLASS_CONFIG</span>, StringDeserializer.<span style=color:#50fa7b>class</span>);
</span></span><span style=display:flex><span>    props.<span style=color:#50fa7b>put</span>(ConsumerConfig.<span style=color:#50fa7b>VALUE_DESERIALIZER_CLASS_CONFIG</span>, StringDeserializer.<span style=color:#50fa7b>class</span>);
</span></span><span style=display:flex><span>    props.<span style=color:#50fa7b>put</span>(ConsumerConfig.<span style=color:#50fa7b>INTERCEPTOR_CLASSES_CONFIG</span>, TracingConsumerInterceptor.<span style=color:#50fa7b>class</span>.<span style=color:#50fa7b>getName</span>());
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> DefaultKafkaConsumerFactory<span style=color:#ff79c6>&lt;&gt;</span>(props);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>That’s all for the Kafka Opentracing instrumentation, it’s pretty simple, right? Then, let’s run this example to see the actual tracing output.</p><h1 id=install-kafka>Install Kafka</h1><p>In order to run the demo application, we’ll need a Kafka cluster installed. You can either deploy Kafka following the guidance in <a href=https://kafka.apache.org/quickstart>Kafka Quickstart</a>, or deploy Kafka in Kubernetes with <a href=https://github.com/strimzi/strimzi-kafka-operator>Kafka Operator</a>.</p><h1 id=deploy-demo-application>Deploy Demo Application</h1><p>Configure k8s/eshop.yaml with the appropriate Kafka bootstrap server address.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yml data-lang=yml><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: extensions/v1beta1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Deployment
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: eshop-v1
</span></span><span style=display:flex><span>  ......
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ff79c6>name</span>: eshop
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>image</span>: zhaohuabing/istio-opentracing-demo:kafka-opentracing
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>ports</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ff79c6>containerPort</span>: <span style=color:#bd93f9>8080</span>
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>env</span>:
</span></span><span style=display:flex><span>          ....
</span></span><span style=display:flex><span>          //在这里加入Kafka server地址
</span></span><span style=display:flex><span>          - <span style=color:#ff79c6>name</span>: KAFKA_BOOTSTRAP_SERVERS
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>value</span>: <span style=color:#f1fa8c>&#34;192.168.89.192:9092&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=color:#ff79c6>apiVersion</span>: extensions/v1beta1
</span></span><span style=display:flex><span><span style=color:#ff79c6>kind</span>: Deployment
</span></span><span style=display:flex><span><span style=color:#ff79c6>metadata</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff79c6>name</span>: kafka-consumer-v1
</span></span><span style=display:flex><span>  ......
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>spec</span>:
</span></span><span style=display:flex><span>      <span style=color:#ff79c6>containers</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ff79c6>name</span>: kafka-consumer
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>image</span>: zhaohuabing/istio-opentracing-demo-kafka-consumer:kafka-opentracing
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>env</span>:
</span></span><span style=display:flex><span>          ....
</span></span><span style=display:flex><span>          //在这里加入Kafka server地址
</span></span><span style=display:flex><span>          - <span style=color:#ff79c6>name</span>: KAFKA_BOOTSTRAP_SERVERS
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>value</span>: <span style=color:#f1fa8c>&#34;192.168.89.192:9092&#34;</span>
</span></span></code></pre></div><p>Then deploy the application in Kubernetes. The docker images are available in docker hub, you could also build the images yourself from source codes.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f k8s/eshop.yaml
</span></span></code></pre></div><p>Input this URL “http://${NODE_IP}:31380/checkout” in your browser to trigger the Restful API of the application, then you should see the generated trace on the Jaeger UI “http://${NODE_IP}:30088”.</p><p><img src=https://zhaohuabing.com/static/img/2019-07-02-using-opentracing-with-istio/istio-tracing-opentracing-kafka.jpg alt></p><p>As the above picture shows, two additional spans have been added to the trace, which represents the message handling at Kafka producer and consumer side respectively. We can see that the reference type between From_eshop_topic Span and To_eshop_topic Span is FOLLOWS_FROM instead of CHILD_OF. That’s because it’s an asynchronous message, so Opentracing uses a FOLLOWS_FROM reference type to indicate there’s no direct dependency between these two Spans.</p><h1 id=propagate-tracing-context-from-kafka-to-rest>Propagate Tracing Context from Kafka to REST</h1><p>For now, tracing context has been propagated from REST calls to Kafka messages, but what if we call a REST API of another service in the message consumer? It would be quite helpful if we could also pass the tracing context from Kafka to the called service, unfortunately, Opentracing instrumentation doesn’t behave as we expected.</p><p>As it shows in the above picture, we can’t see the notification service in the trace of the client request. However, it makes more sense to correlate the REST call to the notification service with the Kafka consumer Span in a single trace because that’s how the client request goes through the system.</p><p>We need to know the concept of “Active Span” first to understand what happened. In the context of Opentracing, “Active Span” represents the current work of a running thread. The “Active Span” of a thread will be implicitly set as the parent span of the newly created span if it’s there, as the below Opentracing source code shows:</p><pre tabindex=0><code>Tracer.SpanBuilder buildSpan(String operationName)
Return a new SpanBuilder for a Span with the given `operationName`.
You can override the operationName later via BaseSpan.setOperationName(String).

A contrived example:


   Tracer tracer = ...

   // Note: if there is a `tracer.activeSpan()`, it will be used as the target of an implicit CHILD_OF
   // Reference for &#34;workSpan&#34; when `startActive()` is invoked.
   try (ActiveSpan workSpan = tracer.buildSpan(&#34;DoWork&#34;).startActive()) {
       workSpan.setTag(&#34;...&#34;, &#34;...&#34;);
       // etc, etc
   }

    // It&#39;s also possible to create Spans manually, bypassing the ActiveSpanSource activation.
   Span http = tracer.buildSpan(&#34;HandleHTTPRequest&#34;)
                     .asChildOf(rpcSpanContext)  // an explicit parent
                     .withTag(&#34;user_agent&#34;, req.UserAgent)
                     .withTag(&#34;lucky_number&#34;, 42)
                     .startManual();
</code></pre><p>However, TracingConsumerInterceptor finishes the Span before it hands over the task to Kafka consumer, so no active span in the current thread when the consumer code invokes the REST API of the notification service. That’s exactly the reason why these two spans are not correlated in a single trace.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd;font-style:italic>static</span> <span style=color:#ff79c6>&lt;</span>K, V<span style=color:#ff79c6>&gt;</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>buildAndFinishChildSpan</span>(ConsumerRecord<span style=color:#ff79c6>&lt;</span>K, V<span style=color:#ff79c6>&gt;</span> record, Tracer tracer,
</span></span><span style=display:flex><span>      BiFunction<span style=color:#ff79c6>&lt;</span>String, ConsumerRecord, String<span style=color:#ff79c6>&gt;</span> consumerSpanNameProvider) {
</span></span><span style=display:flex><span>    SpanContext parentContext <span style=color:#ff79c6>=</span> TracingKafkaUtils.<span style=color:#50fa7b>extractSpanContext</span>(record.<span style=color:#50fa7b>headers</span>(), tracer);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    String consumerOper <span style=color:#ff79c6>=</span>
</span></span><span style=display:flex><span>        FROM_PREFIX <span style=color:#ff79c6>+</span> record.<span style=color:#50fa7b>topic</span>(); <span style=color:#6272a4>// &lt;====== It provides better readability in the UI</span>
</span></span><span style=display:flex><span>    Tracer.<span style=color:#50fa7b>SpanBuilder</span> spanBuilder <span style=color:#ff79c6>=</span> tracer
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>buildSpan</span>(consumerSpanNameProvider.<span style=color:#50fa7b>apply</span>(consumerOper, record))
</span></span><span style=display:flex><span>        .<span style=color:#50fa7b>withTag</span>(Tags.<span style=color:#50fa7b>SPAN_KIND</span>.<span style=color:#50fa7b>getKey</span>(), Tags.<span style=color:#50fa7b>SPAN_KIND_CONSUMER</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>if</span> (parentContext <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>      spanBuilder.<span style=color:#50fa7b>addReference</span>(References.<span style=color:#50fa7b>FOLLOWS_FROM</span>, parentContext);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Span span <span style=color:#ff79c6>=</span> spanBuilder.<span style=color:#50fa7b>start</span>();
</span></span><span style=display:flex><span>    SpanDecorator.<span style=color:#50fa7b>onResponse</span>(record, span);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#6272a4>//Span is finished before the consumer logic</span>
</span></span><span style=display:flex><span>    span.<span style=color:#50fa7b>finish</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    TracingKafkaUtils.<span style=color:#50fa7b>inject</span>(span.<span style=color:#50fa7b>context</span>(), record.<span style=color:#50fa7b>headers</span>(), tracer);
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>This issue can be easily fixed after we figure out the root cause. Given that TracingConsumerInterceptor already put the Kafka Span in the message header, we just need to retrieve that Span from the header, and explicitly set it as the parent Span of the REST call.</p><p>Here is the code snippet to fix it:</p><p>We use a TracingKafka2RestTemplateInterceptor to extract Kafka consumer Span from the message header and set it as the parent Span for the outgoing REST call.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@Override
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> ClientHttpResponse <span style=color:#50fa7b>intercept</span>(HttpRequest httpRequest, <span style=color:#8be9fd>byte</span><span style=color:#ff79c6>[]</span> body, ClientHttpRequestExecution xecution)
</span></span><span style=display:flex><span>        <span style=color:#8be9fd;font-style:italic>throws</span> IOException {
</span></span><span style=display:flex><span>    ClientHttpResponse httpResponse;
</span></span><span style=display:flex><span>    SpanContext parentSpanContext <span style=color:#ff79c6>=</span> TracingKafkaUtils.<span style=color:#50fa7b>extractSpanContext</span>(headers, tracer);
</span></span><span style=display:flex><span>    Span span <span style=color:#ff79c6>=</span> tracer.<span style=color:#50fa7b>buildSpan</span>(httpRequest.<span style=color:#50fa7b>getMethod</span>().<span style=color:#50fa7b>toString</span>()).<span style=color:#50fa7b>asChildOf</span>(parentSpanContext)
</span></span><span style=display:flex><span>            .<span style=color:#50fa7b>withTag</span>(Tags.<span style=color:#50fa7b>SPAN_KIND</span>.<span style=color:#50fa7b>getKey</span>(), Tags.<span style=color:#50fa7b>SPAN_KIND_CLIENT</span>).<span style=color:#50fa7b>start</span>();
</span></span><span style=display:flex><span>    ......
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Configure RestTemplate with the TracingKafka2RestTemplateInterceptor.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>@KafkaListener(topics <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#34;eshop-topic&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>public</span> <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>receiveMessage</span>(ConsumerRecord<span style=color:#ff79c6>&lt;</span>String, String<span style=color:#ff79c6>&gt;</span> record) {
</span></span><span style=display:flex><span>    restTemplate
</span></span><span style=display:flex><span>            .<span style=color:#50fa7b>setInterceptors</span>(Collections.<span style=color:#50fa7b>singletonList</span>(<span style=color:#ff79c6>new</span> TracingKafka2RestTemplateInterceptor(record.<span style=color:#50fa7b>headers</span>())));
</span></span><span style=display:flex><span>    restTemplate.<span style=color:#50fa7b>getForEntity</span>(<span style=color:#f1fa8c>&#34;http://notification:8080/sendEmail&#34;</span>, String.<span style=color:#50fa7b>class</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>That’s all! Now open this URL “http://${NODE_IP}:31380/checkout ” in your browser to invoke the eshop service, then you’ll able to see the whole trace in the Jaeger UI “ http://${NODE_IP}:30088”.</p><p>From the below diagram, you can see how the client request goes through all the services, no matter it’s a REST call or a Kafka message. With this very nice global view, it would be easy to figure out what’s the bottleneck if there is an abnormal latency, or which service has a problem if the client gets an error response.</p><p><img src=https://zhaohuabing.com/static/img/2019-07-02-using-opentracing-with-istio/istio-tracing-opentracing-kafka-rest.jpg alt></p><p>You can also switch between the trace timeline and the trace graph in the Jaeger UI.</p><p><img src=https://zhaohuabing.com/static/img/2019-07-02-using-opentracing-with-istio/trace-graph.jpg alt></p><h1 id=wrap-up>Wrap Up</h1><p>Istio gives you insights into your service mesh by its build-in distributed tracing capability, however, it might not be enough for troubleshooting just by tracing REST calls across process boundaries.</p><p>By leveraging Opentracing instrumentation, we could avoid the trivial code for passing HTTP trace header, and include method-level and Kafka message tracing to the Istio generated trace to provide fine-grained tracing information.</p><p>An ideal solution should be achieving all these goals at the proxy side rather than instrumenting the application. That’s the purpose the service mesh is created for: to offload all the service communication and governance functionalities such as service interconnections, telemetry, security, etc. to the infrastructure layer and let the application only focus on its business logic.</p><p>We’re on the way now, hopefully, we could achieve that ultimate goal soon.</p><h1 id=references>References</h1><ol><li><a href=https://github.com/zhaohuabing/istio-opentracing-demo/tree/kafka-tracking>Eshop demo code on Github</a></li><li><a href=https://objectpartners.com/2019/04/25/distributed-tracing-with-apache-kafka-and-jaeger/>Distributed Tracing with Apache Kafka and Jaeger</a></li><li>[OpenTracing Apache Kafka Client Instrumentation](<a href=https://github.com/opentracing-contrib/java-kafka-client>https://github.com/opentracing-contrib/java-kafka-client</a>
TracingRestTemplateInterceptor.java)</li><li><a href=https://kafka.apache.org/quickstart>Kafka quick start</a></li></ol><div class="entry-shang text-center"><p>「真诚赞赏，手留余香」</p><button class="zs show-zs btn btn-bred">赞赏支持</button></div><div class=zs-modal-bg></div><div class=zs-modal-box><div class=zs-modal-head><button type=button class=close>×</button>
<span class=author><a href=https://lopins.github.io/hugo-template/><img src=/hugo-template/img/favicon.png>Huabing Blog</a></span><p class=tip><i></i><span>真诚赞赏，手留余香</span></p></div><div class=zs-modal-body><div class=zs-modal-btns><button class="btn btn-blink" data-num=2>2元</button>
<button class="btn btn-blink" data-num=5>5元</button>
<button class="btn btn-blink" data-num=10>10元</button>
<button class="btn btn-blink" data-num=50>50元</button>
<button class="btn btn-blink" data-num=100>100元</button>
<button class="btn btn-blink" data-num=1>任意金额</button></div><div class=zs-modal-pay><button class="btn btn-bred" id=pay-text>2元</button><p>使用<span id=pay-type>微信</span>扫描二维码完成支付</p><img src=/hugo-template/img/reward/wechat-2.png id=pay-image></div></div><div class=zs-modal-footer><label><input type=radio name=zs-type value=wechat class=zs-type checked><span><span class=zs-wechat><img src=/hugo-template/img/reward/wechat-btn.png></span></label>
<label><input type=radio name=zs-type value=alipay class=zs-type class=zs-alipay><img src=/hugo-template/img/reward/alipay-btn.png></span></label></div></div><script type=text/javascript src=/hugo-template/js/reward.js></script><hr><ul class=pager><li class=previous><a href=/hugo-template/post/2019-06-22-using-opentracing-with-istio-english/ data-toggle=tooltip data-placement=top title="Enhance Istio Distributed Tracing with OpenTracing">&larr;
Previous Post</a></li><li class=next><a href=/hugo-template/post/2019-10-21-pilot-discovery-code-analysis/ data-toggle=tooltip data-placement=top title="Istio Pilot代码深度解析">Next
Post &rarr;</a></li></ul><link href=https://xxx.xxx.com/dist/Artalk.css rel=stylesheet><script src=https://xxx.xxx.com/dist/Artalk.js></script><div id=Comments></div><script>Artalk.init({el:"#Comments",pageKey:"https://lopins.github.io/hugo-template/post/2019-07-02-using-opentracing-with-istio-english/",pageTitle:"Enhance Istio Distributed Tracing with OpenTracing",server:"https://xxx.xxx.com",site:"xxx blog"})</script></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5><a href=/tags/>FEATURED TAGS</a></h5><div class=tags><a href=/tags/aeraki title=aeraki>aeraki
</a><a href=/tags/aeraki-mesh title="aeraki mesh">aeraki mesh
</a><a href=/tags/ambient-mesh title="ambient mesh">ambient mesh
</a><a href=/tags/api-gateway title="api gateway">api gateway
</a><a href=/tags/bitcoin title=bitcoin>bitcoin
</a><a href=/tags/blockchain title=blockchain>blockchain
</a><a href=/tags/cka title=cka>cka
</a><a href=/tags/cncf title=cncf>cncf
</a><a href=/tags/cryptocurrency title=cryptocurrency>cryptocurrency
</a><a href=/tags/digital-signature title="digital signature">digital signature
</a><a href=/tags/docker title=docker>docker
</a><a href=/tags/dubbo title=dubbo>dubbo
</a><a href=/tags/envoy title=envoy>envoy
</a><a href=/tags/envoy-gateway title="envoy gateway">envoy gateway
</a><a href=/tags/ingress title=ingress>ingress
</a><a href=/tags/istio title=istio>istio
</a><a href=/tags/jaeger title=jaeger>jaeger
</a><a href=/tags/kafka title=kafka>kafka
</a><a href=/tags/knowledge-graph title="knowledge graph">knowledge graph
</a><a href=/tags/kubecon title=kubecon>kubecon
</a><a href=/tags/kubernetes title=kubernetes>kubernetes
</a><a href=/tags/linux title=linux>linux
</a><a href=/tags/loadbalancer title=loadbalancer>loadbalancer
</a><a href=/tags/metaprotocol title=metaprotocol>metaprotocol
</a><a href=/tags/microservice title=microservice>microservice
</a><a href=/tags/network title=network>network
</a><a href=/tags/network-service-mesh title="network service mesh">network service mesh
</a><a href=/tags/nfv title=nfv>nfv
</a><a href=/tags/nodeport title=nodeport>nodeport
</a><a href=/tags/onap title=onap>onap
</a><a href=/tags/opentracing title=opentracing>opentracing
</a><a href=/tags/pilot title=pilot>pilot
</a><a href=/tags/proxy-protocol title="proxy protocol">proxy protocol
</a><a href=/tags/redis title=redis>redis
</a><a href=/tags/sdn title=sdn>sdn
</a><a href=/tags/security title=security>security
</a><a href=/tags/service-mesh title="service mesh">service mesh
</a><a href=/tags/tencent title=tencent>tencent
</a><a href=/tags/x-forwarded-for title=x-forwarded-for>x-forwarded-for</a></div></section><section><hr><h5>FRIENDS</h5><ul class=list-inline><li><a target=_blank href=https://zhaozhihan.com>Linda的博客</a></li></ul></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:youremail@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=/hugo-template/your%20wechat%20qr%20code%20image><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-weixin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/yourgithub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://www.linkedin.com/in/yourlinkedinid><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://stackoverflow.com/users/yourstackoverflowid><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li><li><a href rel=alternate type=application/rss+xml title="Huabing Blog"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; Huabing Blog 2024<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://zhaohuabing.com>Huabing</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe></p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,a=$(_containerSelector),r=a.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),r.each(function(){t=$(this).prop("tagName").toLowerCase(),o="#"+$(this).prop("id"),n=$(this).text(),i=$('<a href="'+o+'" rel="nofollow">'+n+"</a>"),s=$('<li class="'+t+'_nav"></li>').append(i),$(e).append(s)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/hugo-template/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>