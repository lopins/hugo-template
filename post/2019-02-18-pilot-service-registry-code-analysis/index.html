<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="Huabing Blog"><meta property="og:type" content="article"><meta property="og:image" content="https://zhaohuabing.com/static/img/post-bg-unix-linux.jpg"><meta property="twitter:image" content="https://zhaohuabing.com/static/img/post-bg-unix-linux.jpg"><meta name=title content="Istio 服务注册插件机制代码解析"><meta property="og:title" content="Istio 服务注册插件机制代码解析"><meta property="twitter:title" content="Istio 服务注册插件机制代码解析"><meta name=description content="本文将从代码出发，对Pilot的服务注册插件机制进行分析。"><meta property="og:description" content="本文将从代码出发，对Pilot的服务注册插件机制进行分析。"><meta property="twitter:description" content="本文将从代码出发，对Pilot的服务注册插件机制进行分析。"><meta property="twitter:card" content="summary"><meta name=keyword content="赵化冰, zhaohuabing, Zhaohuabing, , 赵化冰的网络日志, 赵化冰的博客, Zhaohuabing Blog, 博客, 个人网站, 互联网, Web, 云原生, PaaS, Istio, Kubernetes, 微服务, Microservice"><link rel="shortcut icon" href=/hugo-template/img/favicon.ico><title>Istio 服务注册插件机制代码解析 | 赵化冰的博客 | Zhaohuabing Blog</title>
<link rel=canonical href=/hugo-template/post/2019-02-18-pilot-service-registry-code-analysis/><link rel=stylesheet href=/hugo-template/css/bootstrap.min.css><link rel=stylesheet href=/hugo-template/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=/hugo-template/css/zanshang.css><link rel=stylesheet href=/hugo-template/css/font-awesome.all.min.css><script src=/hugo-template/js/jquery.min.js></script><script src=/hugo-template/js/bootstrap.min.js></script><script src=/hugo-template/js/hux-blog.min.js></script><script src=/hugo-template/js/lazysizes.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=/>Huabing Blog</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/>All Posts</a></li><li><a href=/hugo-template/categories/books/>books</a></li><li><a href=/hugo-template/categories/open-source/>open source</a></li><li><a href=/hugo-template/categories/presentations/>presentations</a></li><li><a href=/hugo-template/categories/tech/>tech</a></li><li><a href=/archive//>ARCHIVE</a></li><li><a href=/notes//>NOTES</a></li><li><a href=/about//>ABOUT</a></li><li><a href=/hugo-template/search><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(https://zhaohuabing.com/static/img/post-bg-unix-linux.jpg)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/service-mesh title="Service Mesh">Service Mesh
</a><a class=tag href=/tags/istio title=Istio>Istio</a></div><h1>Istio 服务注册插件机制代码解析</h1><h2 class=subheading></h2><span class=meta>Posted by
    "赵化冰"
on
Monday, February 18, 2019</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><h1 id=istio服务注册插件机制>Istio服务注册插件机制</h1><p>在Istio架构中，Pilot组件负责维护网格中的标准服务模型，该标准服务模型独立于各种底层平台，Pilot通过适配器和各底层平台对接，以使用底层平台中的服务数据填充此标准模型。</p><p>例如Pilot中的Kubernetes适配器通过Kubernetes API Server到kubernetes中的Service以及对应的POD实例，将该数据被翻译为标准模型提供给Pilot使用。通过适配器模式，Pilot还可以从Cloud Foundry, Consul中获取服务信息，也可以开发适配器将其他提供服务发现的组件集成到Pilot中。
<img src=https://zhaohuabing.com/static/img/2019-02-18-pilot-service-registry-code-analysis/pilot.png alt></p><p>本文将从代码出发，对Pilot的服务注册机制进行分析。</p><p>备注： 本文分析的代码对应Istio commit 58186e1dc3392de842bc2b2c788f993878e0f123</p><h1 id=服务注册相关的对象>服务注册相关的对象</h1><p>首先我们来了解一下Pilot中关于服务注册的一些基本概念和相关数据结构。</p><p>Istio源码中，和服务注册相关的对象如下面的UML类图所示。</p><p><img src=https://zhaohuabing.com/static/img/2019-02-18-pilot-service-registry-code-analysis/class-diagram.png alt></p><h2 id=service>Service</h2><p>源码文件：pilot/pkg/model/service.go</p><p>Service用于表示Istio服务网格中的一个服务（例如 catalog.mystore.com:8080)。每一个服务有一个全限定域名(FQDN)和一个或者多个接收客户端请求的监听端口。</p><p>一个服务可以有一个可选的 负载均衡器/虚拟IP，DNS解析会对应到该虚拟IP（负载均衡器的IP）上。 一般来说，不管后端的服务实例如何变化，VIP是不会变化的，Istio会维护VIP和后端实例真实IP的对应关系。</p><p>例如在Kubernetes中，服务 foo 的FQDN为foo.default.svc.cluster.local， 拥有一个虚拟IP 10.0.1.1，在端口80和8080上监听客户端请求。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>type</span> Service <span style=color:#8be9fd;font-style:italic>struct</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// Hostn/服务器名
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        Hostname Hostname <span style=color:#f1fa8c>`json:&#34;hostname&#34;`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 虚拟IP / 负载均衡器 IP
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        Address <span style=color:#8be9fd>string</span> <span style=color:#f1fa8c>`json:&#34;address,omitempty&#34;`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 如果服务部署在多个集群中，ClusterVIPs会保存不同集群中该服务对应的VIP
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        ClusterVIPs <span style=color:#8be9fd;font-style:italic>map</span>[<span style=color:#8be9fd>string</span>]<span style=color:#8be9fd>string</span> <span style=color:#f1fa8c>`json:&#34;cluster-vips,omitempty&#34;`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 服务端口列表
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        Ports PortList <span style=color:#f1fa8c>`json:&#34;ports,omitempty&#34;`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 运行该服务的服务账号
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        ServiceAccounts []<span style=color:#8be9fd>string</span> <span style=color:#f1fa8c>`json:&#34;serviceaccounts,omitempty&#34;`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 该服务是否为一个 “外部服务”， 采用 ServiceEntry 定义的服务该标志为true
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        MeshExternal <span style=color:#8be9fd>bool</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 服务解析规则： 包括 
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// ClientSideLB: 由Envoy代理根据其本地的LB pool进行请求路由
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// DNSLB: 查询DNS服务器得到IP地址，并将请求发到该IP
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// Passthrough： 将请求发转发到其原始目的地
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        Resolution Resolution
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 服务创建时间
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        CreationTime time.Time <span style=color:#f1fa8c>`json:&#34;creationTime,omitempty&#34;`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 服务的一些附加属性
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        Attributes ServiceAttributes
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=serviceinstance>ServiceInstance</h2><p>源码文件：pilot/pkg/model/service.go</p><p>SercieInstance中存放了服务实例相关的信息，一个Service可以对应到一到多个Service Instance，Istio在收到客户端请求时，会根据该Service配置的LB策略和路由规则从可用的Service Instance中选择一个来提供服务。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>type</span> ServiceInstance <span style=color:#8be9fd;font-style:italic>struct</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// Endpoint中包括服务实例的IP：Port，UID等
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        Endpoint       NetworkEndpoint <span style=color:#f1fa8c>`json:&#34;endpoint,omitempty&#34;`</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 对应的服务
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        Service        <span style=color:#ff79c6>*</span>Service        <span style=color:#f1fa8c>`json:&#34;service,omitempty&#34;`</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 该实例上的标签，例如版本号
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        Labels         Labels          <span style=color:#f1fa8c>`json:&#34;labels,omitempty&#34;`</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 运行该服务的服务账号
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        ServiceAccount <span style=color:#8be9fd>string</span>          <span style=color:#f1fa8c>`json:&#34;serviceaccount,omitempty&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=registry>Registry</h2><p>源码文件： pilot/pkg/serviceregistry/aggregate/controller.go</p><p>Registry代表一个通过适配器插入到Pilot中的服务注册表，即Kubernetes，Cloud Foundry 或者 Consul 等具体后端的服务部署/服务注册发现平台。</p><p>Registry结构体中包含了Service Registry相关的一些接口和属性。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>type</span> Registry <span style=color:#8be9fd;font-style:italic>struct</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 注册表的类型，例如Kubernetes, Consul, 等等。
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        Name serviceregistry.ServiceRegistry
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 某些类型的服务注册表支持多集群，例如Kubernetes，在这种情况下需要用CluterID来区分同一类型下不同集群的服务注册表
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        ClusterID <span style=color:#8be9fd>string</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 控制器，负责向外发送该Registry相关的Service变化消息
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        model.Controller
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 服务发现接口，用于获取注册表中的服务信息
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        model.ServiceDiscovery
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Istio支持以下几种服务注册表类型：</p><p>源码文件： pilot/pkg/serviceregistry/platform.go</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#6272a4>// ServiceRegistry defines underlying platform supporting service registry
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>type</span> ServiceRegistry <span style=color:#8be9fd>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>const</span> (
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// MockRegistry,用于测试的服务注册表，包含两个硬编码的test services
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        MockRegistry ServiceRegistry = <span style=color:#f1fa8c>&#34;Mock&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// ConfigRegistry,可以从Configstore中获取定义的service registry，加入到Istio的服务列表中
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        KubernetesRegistry ServiceRegistry = <span style=color:#f1fa8c>&#34;Kubernetes&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 从Consul获取服务数据的服务注册表
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        ConsulRegistry ServiceRegistry = <span style=color:#f1fa8c>&#34;Consul&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 采用“Mesh Configuration Protocol”的服务注册表
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        MCPRegistry ServiceRegistry = <span style=color:#f1fa8c>&#34;MCP&#34;</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>其中支持最完善的就是Kubernetes了，我在项目中使用了Consul，填坑的经验证明对Consul的支持只是原型验证级别的，要在产品中使用的话还需要对其进行较多的改进和优化。</p><p>注册表中最后一个类型是 MCP，MCP 是 “Mesh Configuration Protocol" 的缩写。 Istio 使用了 MCP 实现了一个服务注册和路由配置的标准接口，MCP Server可以从Kubernetes，Cloud Foundry, Consul等获取服务信息和配置数据，并将这些信息通过MCP提供给 MCP Client，即Pilot，通过这种方式，将目前特定平台的相关的代码从Pilot中剥离到独立的MCP服务器中，使Pilot的架构和代码更为清晰。MCP将逐渐替换目前的各种Adapter。更多关于MCP的内容参见：</p><ul><li><a href=https://docs.google.com/document/d/1o2-V4TLJ8fJACXdlsnxKxDv2Luryo48bAhR8ShxE5-k/edit>https://docs.google.com/document/d/1o2-V4TLJ8fJACXdlsnxKxDv2Luryo48bAhR8ShxE5-k/edit</a></li><li><a href=https://docs.google.com/document/d/1S5ygkxR1alNI8cWGG4O4iV8zp8dA6Oc23zQCvFxr83U/edit>https://docs.google.com/document/d/1S5ygkxR1alNI8cWGG4O4iV8zp8dA6Oc23zQCvFxr83U/edit</a></li></ul><h2 id=controller>Controller</h2><p>源码文件： pilot/pkg/model/controller.go</p><p>Controller抽象了一个Service Registry变化通知的接口，该接口会将Service及Service Instance的增加，删除，变化等消息通知给ServiceHandler。</p><p>调用Controller的Run方法后，Controller会一直执行，将监控Service Registry的变化，并将通知到注册到Controller中的ServiceHandler中。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>type</span> Controller <span style=color:#8be9fd;font-style:italic>interface</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 添加一个Service Handler，服务的变化会通知到该Handler
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>AppendServiceHandler</span>(f <span style=color:#8be9fd;font-style:italic>func</span>(<span style=color:#ff79c6>*</span>Service, Event)) <span style=color:#8be9fd>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 添加一个Service Instance Handler， 服务实例的变化会通知到该Handler
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>AppendInstanceHandler</span>(f <span style=color:#8be9fd;font-style:italic>func</span>(<span style=color:#ff79c6>*</span>ServiceInstance, Event)) <span style=color:#8be9fd>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 启动Controller的主循环，对Service Catalog的变化进行分发
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>Run</span>(stop <span style=color:#ff79c6>&lt;-</span><span style=color:#8be9fd;font-style:italic>chan</span> <span style=color:#8be9fd;font-style:italic>struct</span>{})
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=servicediscovery>ServiceDiscovery</h2><p>源码文件： pilot/pkg/model/service.go</p><p>ServiceDiscovery抽象了一个服务发现的接口，可以通过该接口获取到Service Registry中的Service和Service Instance。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>type</span> ServiceDiscovery <span style=color:#8be9fd;font-style:italic>interface</span> {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 列出该Service Registry中的所有服务
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>Services</span>() ([]<span style=color:#ff79c6>*</span>Service, <span style=color:#8be9fd>error</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 根据主机名查询服务
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#6272a4>// 该接口已废弃
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>GetService</span>(hostname Hostname) (<span style=color:#ff79c6>*</span>Service, <span style=color:#8be9fd>error</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 根据主机名，服务端点和标签查询服务实例
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>InstancesByPort</span>(hostname Hostname, servicePort <span style=color:#8be9fd>int</span>, labels LabelsCollection) ([]<span style=color:#ff79c6>*</span>ServiceInstance, <span style=color:#8be9fd>error</span>)
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// 查询边车代理所在节点上的服务实例 
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>		<span style=color:#50fa7b>GetProxyServiceInstances</span>(<span style=color:#ff79c6>*</span>Proxy) ([]<span style=color:#ff79c6>*</span>ServiceInstance, <span style=color:#8be9fd>error</span>)
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// 获取边车代理所在的Region,Zone和SubZone
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>GetProxyLocality</span>(<span style=color:#ff79c6>*</span>Proxy) <span style=color:#8be9fd>string</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// 管理端口，Istio生成的配置会将管理端口的流量排除，不进行路由处理
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>ManagementPorts</span>(addr <span style=color:#8be9fd>string</span>) PortList
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// 列出用于监控检查的探针
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#50fa7b>WorkloadHealthCheckInfo</span>(addr <span style=color:#8be9fd>string</span>) ProbeList
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=service-registry初始化流程>Service Registry初始化流程</h1><p>Service Registry初始化的主要逻辑在Pilot-discovery程序的主函数中，对应的源码为：pilot/cmd/pilot-discovery/main.go和pilot/pkg/bootstrap/server.go。</p><p>在pilot/pkg/bootstrap/server.go中，初始化了各种Service Registry，其流程如下图所示：
（备注： MCP Registry尚在开发过程中）
<img src=https://zhaohuabing.com/static/img/2019-02-18-pilot-service-registry-code-analysis/init-service-registry.png alt></p><p>Pilot将各个Service Registry(Memory, Kube, Consul)保存在serviceregistry.aggreagete.Controller中进行统一管理，Pilot会从所有类型的Registry中查询服务和服务实例，并监控所有Registry的数据变化,当Registry数据变化后，Pilot会清空其内部的缓存并通过ADS接口向Envoy推送更新。
<img src=https://zhaohuabing.com/static/img/2019-02-18-pilot-service-registry-code-analysis/controller.jpg alt></p><blockquote><p>备注：上图中的controller实际上是Service Registry，aggregate controller和具体的各个类型的controller同时实现了Registry要求的controller和discovery interface。</p></blockquote><p>Registry的业务逻辑在Kube Controller和Consul controller中，我们主要使用了Consul Controller， 其主要方法如下：</p><p>源码文件： pilot/pkg/serviceregistry/consul/controller.go</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>▼<span style=color:#ff79c6>+</span>Controller : <span style=color:#8be9fd;font-style:italic>struct</span>
</span></span><span style=display:flex><span>    [fields]
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>-</span>client : <span style=color:#ff79c6>*</span>api.Client
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>-</span>monitor : Monitor
</span></span><span style=display:flex><span>    [methods]
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>+</span><span style=color:#50fa7b>AppendInstanceHandler</span>(f <span style=color:#8be9fd;font-style:italic>func</span>(<span style=color:#ff79c6>*</span>model.ServiceInstance, model.Event)) : <span style=color:#8be9fd>error</span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>+</span><span style=color:#50fa7b>AppendServiceHandler</span>(f <span style=color:#8be9fd;font-style:italic>func</span>(<span style=color:#ff79c6>*</span>model.Service, model.Event)) : <span style=color:#8be9fd>error</span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>+</span><span style=color:#50fa7b>GetIstioServiceAccounts</span>(hostname model.Hostname, ports []<span style=color:#8be9fd>int</span>) : []<span style=color:#8be9fd>string</span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>+</span><span style=color:#50fa7b>GetProxyServiceInstances</span>(node <span style=color:#ff79c6>*</span>model.Proxy) : []<span style=color:#ff79c6>*</span>model.ServiceInstance, <span style=color:#8be9fd>error</span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>+</span><span style=color:#50fa7b>GetService</span>(hostname model.Hostname) : <span style=color:#ff79c6>*</span>model.Service, <span style=color:#8be9fd>error</span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>+</span><span style=color:#50fa7b>InstancesByPort</span>(hostname model.Hostname, port <span style=color:#8be9fd>int</span>, labels model.LabelsCollection) : []<span style=color:#ff79c6>*</span>model.ServiceInstance, <span style=color:#8be9fd>error</span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>+</span><span style=color:#50fa7b>ManagementPorts</span>(addr <span style=color:#8be9fd>string</span>) : model.PortList
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>+</span><span style=color:#50fa7b>Run</span>(stop <span style=color:#8be9fd;font-style:italic>chan</span> )
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>+</span><span style=color:#50fa7b>Services</span>() : []<span style=color:#ff79c6>*</span>model.Service, <span style=color:#8be9fd>error</span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>+</span><span style=color:#50fa7b>WorkloadHealthCheckInfo</span>(addr <span style=color:#8be9fd>string</span>) : model.ProbeList
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>-</span><span style=color:#50fa7b>getCatalogService</span>(name <span style=color:#8be9fd>string</span>, q <span style=color:#ff79c6>*</span>api.QueryOptions) : []<span style=color:#ff79c6>*</span>api.CatalogService, <span style=color:#8be9fd>error</span>
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>-</span><span style=color:#50fa7b>getServices</span>() : <span style=color:#8be9fd;font-style:italic>map</span>[<span style=color:#8be9fd>string</span>][]<span style=color:#8be9fd>string</span>, <span style=color:#8be9fd>error</span>
</span></span><span style=display:flex><span>    [functions]
</span></span><span style=display:flex><span>   <span style=color:#ff79c6>+</span><span style=color:#50fa7b>NewController</span>(addr <span style=color:#8be9fd>string</span>, interval time.Duration) : <span style=color:#ff79c6>*</span>Controller, <span style=color:#8be9fd>error</span>
</span></span></code></pre></div><p>可以看到Consul Controller对象同时实现了Registry要求的Controller和ServiceDiscovery接口，可以提供Registry的变化通知和服务查询相关功能。</p><p>目前Consul Controller的实现比较简单粗暴，定时通过Consul的Rest API获取服务数据并和上一次的查询结果进行对比，如果数据发生了变化则通知Pilot discovery进行更新。该方式发起了大量对Consul Server的HTTP请求，会导致Consul Server CPU占用率高和大量TCP Socket处于TIME_WAIT状态，不能直接在产品环境下使用。</p><p>源码文件： pilot/pkg/serviceregistry/consul/monitor.go</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#6272a4>//定时轮询Consul Server Rest接口，以获取服务数据变化
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>func</span> (m <span style=color:#ff79c6>*</span>consulMonitor) <span style=color:#50fa7b>run</span>(stop <span style=color:#ff79c6>&lt;-</span><span style=color:#8be9fd;font-style:italic>chan</span> <span style=color:#8be9fd;font-style:italic>struct</span>{}) {
</span></span><span style=display:flex><span>        ticker <span style=color:#ff79c6>:=</span> time.<span style=color:#50fa7b>NewTicker</span>(m.period)
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>for</span> {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>select</span> {
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>case</span> <span style=color:#ff79c6>&lt;-</span>stop:
</span></span><span style=display:flex><span>                        ticker.<span style=color:#50fa7b>Stop</span>()
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>return</span>
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>case</span> <span style=color:#ff79c6>&lt;-</span>ticker.C:
</span></span><span style=display:flex><span>                        m.<span style=color:#50fa7b>updateServiceRecord</span>()
</span></span><span style=display:flex><span>                        m.<span style=color:#50fa7b>updateInstanceRecord</span>()
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>//比较这一次和上一次的服务数据，如有变化则回调ServiceHandler进行通知
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span><span style=color:#8be9fd;font-style:italic>func</span> (m <span style=color:#ff79c6>*</span>consulMonitor) <span style=color:#50fa7b>updateServiceRecord</span>() {
</span></span><span style=display:flex><span>        svcs, _, err <span style=color:#ff79c6>:=</span> m.discovery.<span style=color:#50fa7b>Catalog</span>().<span style=color:#50fa7b>Services</span>(<span style=color:#ff79c6>nil</span>)
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span>                log.<span style=color:#50fa7b>Warnf</span>(<span style=color:#f1fa8c>&#34;Could not fetch services: %v&#34;</span>, err)
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>return</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        newRecord <span style=color:#ff79c6>:=</span> <span style=color:#50fa7b>consulServices</span>(svcs)
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> !reflect.<span style=color:#50fa7b>DeepEqual</span>(newRecord, m.serviceCachedRecord) {
</span></span><span style=display:flex><span>                <span style=color:#6272a4>// This is only a work-around solution currently
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>                <span style=color:#6272a4>// Since Handler functions generally act as a refresher
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>                <span style=color:#6272a4>// regardless of the input, thus passing in meaningless
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>                <span style=color:#6272a4>// input should make functionalities work
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>                <span style=color:#6272a4>//TODO
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>                obj <span style=color:#ff79c6>:=</span> []<span style=color:#ff79c6>*</span>api.CatalogService{}
</span></span><span style=display:flex><span>                <span style=color:#8be9fd;font-style:italic>var</span> event model.Event
</span></span><span style=display:flex><span>                <span style=color:#ff79c6>for</span> _, f <span style=color:#ff79c6>:=</span> <span style=color:#ff79c6>range</span> m.serviceHandlers {
</span></span><span style=display:flex><span>                        <span style=color:#ff79c6>go</span> <span style=color:#8be9fd;font-style:italic>func</span>(handler ServiceHandler) {
</span></span><span style=display:flex><span>                                <span style=color:#ff79c6>if</span> err <span style=color:#ff79c6>:=</span> <span style=color:#50fa7b>handler</span>(obj, event); err <span style=color:#ff79c6>!=</span> <span style=color:#ff79c6>nil</span> {
</span></span><span style=display:flex><span>                                        log.<span style=color:#50fa7b>Warnf</span>(<span style=color:#f1fa8c>&#34;Error executing service handler function: %v&#34;</span>, err)
</span></span><span style=display:flex><span>                                }
</span></span><span style=display:flex><span>                        }(f)
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                m.serviceCachedRecord = newRecord
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>我们在Consul Registry中增加了缓存，并降低了Pilot轮询Consul server的频率，以减少Pilot频繁调用给Consul server带来的大量压力，下一步打算采用Consul watch来代替轮询，优化Consul Registry的服务变化通知机制。</p><div class="entry-shang text-center"><p>「真诚赞赏，手留余香」</p><button class="zs show-zs btn btn-bred">赞赏支持</button></div><div class=zs-modal-bg></div><div class=zs-modal-box><div class=zs-modal-head><button type=button class=close>×</button>
<span class=author><a href=https://lopins.github.io/hugo-template/><img src=/hugo-template/img/favicon.png>Huabing Blog</a></span><p class=tip><i></i><span>真诚赞赏，手留余香</span></p></div><div class=zs-modal-body><div class=zs-modal-btns><button class="btn btn-blink" data-num=2>2元</button>
<button class="btn btn-blink" data-num=5>5元</button>
<button class="btn btn-blink" data-num=10>10元</button>
<button class="btn btn-blink" data-num=50>50元</button>
<button class="btn btn-blink" data-num=100>100元</button>
<button class="btn btn-blink" data-num=1>任意金额</button></div><div class=zs-modal-pay><button class="btn btn-bred" id=pay-text>2元</button><p>使用<span id=pay-type>微信</span>扫描二维码完成支付</p><img src=/hugo-template/img/reward/wechat-2.png id=pay-image></div></div><div class=zs-modal-footer><label><input type=radio name=zs-type value=wechat class=zs-type checked><span><span class=zs-wechat><img src=/hugo-template/img/reward/wechat-btn.png></span></label>
<label><input type=radio name=zs-type value=alipay class=zs-type class=zs-alipay><img src=/hugo-template/img/reward/alipay-btn.png></span></label></div></div><script type=text/javascript src=/hugo-template/js/reward.js></script><hr><ul class=pager><li class=previous><a href=/hugo-template/post/2019-01-21-git/ data-toggle=tooltip data-placement=top title=Git内部存储原理>&larr;
Previous Post</a></li><li class=next><a href=/hugo-template/post/2019-03-29-how-to-choose-ingress-for-service-mesh/ data-toggle=tooltip data-placement=top title=如何为服务网格选择入口网关？>Next
Post &rarr;</a></li></ul><link href=https://xxx.xxx.com/dist/Artalk.css rel=stylesheet><script src=https://xxx.xxx.com/dist/Artalk.js></script><div id=Comments></div><script>Artalk.init({el:"#Comments",pageKey:"https://lopins.github.io/hugo-template/post/2019-02-18-pilot-service-registry-code-analysis/",pageTitle:"Istio 服务注册插件机制代码解析",server:"https://xxx.xxx.com",site:"xxx blog"})</script></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5><a href=/tags/>FEATURED TAGS</a></h5><div class=tags><a href=/tags/aeraki title=aeraki>aeraki
</a><a href=/tags/aeraki-mesh title="aeraki mesh">aeraki mesh
</a><a href=/tags/ambient-mesh title="ambient mesh">ambient mesh
</a><a href=/tags/api-gateway title="api gateway">api gateway
</a><a href=/tags/bitcoin title=bitcoin>bitcoin
</a><a href=/tags/blockchain title=blockchain>blockchain
</a><a href=/tags/cka title=cka>cka
</a><a href=/tags/cncf title=cncf>cncf
</a><a href=/tags/cryptocurrency title=cryptocurrency>cryptocurrency
</a><a href=/tags/digital-signature title="digital signature">digital signature
</a><a href=/tags/docker title=docker>docker
</a><a href=/tags/dubbo title=dubbo>dubbo
</a><a href=/tags/envoy title=envoy>envoy
</a><a href=/tags/envoy-gateway title="envoy gateway">envoy gateway
</a><a href=/tags/ingress title=ingress>ingress
</a><a href=/tags/istio title=istio>istio
</a><a href=/tags/jaeger title=jaeger>jaeger
</a><a href=/tags/kafka title=kafka>kafka
</a><a href=/tags/knowledge-graph title="knowledge graph">knowledge graph
</a><a href=/tags/kubecon title=kubecon>kubecon
</a><a href=/tags/kubernetes title=kubernetes>kubernetes
</a><a href=/tags/linux title=linux>linux
</a><a href=/tags/loadbalancer title=loadbalancer>loadbalancer
</a><a href=/tags/metaprotocol title=metaprotocol>metaprotocol
</a><a href=/tags/microservice title=microservice>microservice
</a><a href=/tags/network title=network>network
</a><a href=/tags/network-service-mesh title="network service mesh">network service mesh
</a><a href=/tags/nfv title=nfv>nfv
</a><a href=/tags/nodeport title=nodeport>nodeport
</a><a href=/tags/onap title=onap>onap
</a><a href=/tags/opentracing title=opentracing>opentracing
</a><a href=/tags/pilot title=pilot>pilot
</a><a href=/tags/proxy-protocol title="proxy protocol">proxy protocol
</a><a href=/tags/redis title=redis>redis
</a><a href=/tags/sdn title=sdn>sdn
</a><a href=/tags/security title=security>security
</a><a href=/tags/service-mesh title="service mesh">service mesh
</a><a href=/tags/tencent title=tencent>tencent
</a><a href=/tags/x-forwarded-for title=x-forwarded-for>x-forwarded-for</a></div></section><section><hr><h5>FRIENDS</h5><ul class=list-inline><li><a target=_blank href=https://zhaozhihan.com>Linda的博客</a></li></ul></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=mailto:youremail@gmail.com><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=/hugo-template/your%20wechat%20qr%20code%20image><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-weixin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://github.com/yourgithub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://www.linkedin.com/in/yourlinkedinid><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a target=_blank href=https://stackoverflow.com/users/yourstackoverflowid><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li><li><a href rel=alternate type=application/rss+xml title="Huabing Blog"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; Huabing Blog 2024<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://zhaohuabing.com>Huabing</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe></p></div></div></div></footer><script>function loadAsync(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(null,e)},!1),i.parentNode.insertBefore(n,i)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,a=$(_containerSelector),r=a.find("h1,h2,h3,h4,h5,h6");return $(e).html(""),r.each(function(){t=$(this).prop("tagName").toLowerCase(),o="#"+$(this).prop("id"),n=$(this).text(),i=$('<a href="'+o+'" rel="nofollow">'+n+"</a>"),s=$('<li class="'+t+'_nav"></li>').append(i),$(e).append(s)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("/hugo-template/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script></body></html>